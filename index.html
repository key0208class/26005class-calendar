<!doctype html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (v1.6.0) æ›´æ–°ç‰ˆæœ¬è™Ÿ -->
    <title>é›²æ•™å®¤è¡Œäº‹æ›† v1.1.0</title>

    <!-- åŒ¯å…¥ Firebase SDK -->
    <script type="module">
        // åŒ¯å…¥ Firebase æ ¸å¿ƒ App
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // åŒ¯å…¥ Firebase é©—è­‰ (Auth)
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // åŒ¯å…¥ Firebase é›²ç«¯è³‡æ–™åº« (Firestore)
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            writeBatch, // (v1.4.0) åŒ¯å…¥æ‰¹æ¬¡å¯«å…¥
            where,      // (v1.6.0) åŒ¯å…¥ where æŸ¥è©¢
            getDocs     // (v1.6.0) åŒ¯å…¥ getDocs ä»¥æŸ¥è©¢ groupId
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ğŸ”¥ğŸ”¥ğŸ”¥ Firebase è¨­å®š ğŸ”¥ğŸ”¥ğŸ”¥
        // (æ­¤è™•æ²¿ç”¨æ‚¨å…ˆå‰ç‰ˆæœ¬ä¸­çš„è¨­å®š)
        const firebaseConfig = {
            apiKey: "AIzaSyB4aHwmiGMsxlLFuINdneE7v2DGWwD_-VA",
            authDomain: "myclass26005-calendar.firebaseapp.com",
            projectId: "myclass26005-calendar",
            storageBucket: "myclass26005-calendar.firebasestorage.app",
            messagingSenderId: "123055248147",
            appId: "1:123055248147:web:c9b2bc6e1d6a6b9a58c0e6"
        };
        // ğŸ”¥ğŸ”¥ğŸ”¥ Firebase è¨­å®šçµæŸ ğŸ”¥ğŸ”¥ğŸ”¥

        // ---
        // âš ï¸âš ï¸âš ï¸ ã€é‡è¦ã€‘ç®¡ç†å“¡è¨­å®š âš ï¸âš ï¸âš ï¸
        // è«‹å°‡æ‚¨è‡ªå·±çš„ Google å¸³è™Ÿç™»å…¥å¾Œçš„ UID è²¼åœ¨ä¸‹æ–¹ã€‚
        // å¦‚ä½•å–å¾— UIDï¼š
        // 1. ç™»å…¥ä¸€æ¬¡è¡Œäº‹æ›†ã€‚
        // 2. æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12)ã€‚
        // 3. åœ¨ Console (ä¸»æ§å°) ä¸­æ‰¾åˆ° "ç›®å‰ä½¿ç”¨è€… UID:" çš„è¨Šæ¯ï¼Œè¤‡è£½é‚£ä¸²è‹±æ•¸æ··åˆçš„å­—ä¸²ã€‚
        const ADMIN_UID = "PhJQtK5Hd2SDQuCwpyU0oPpL4gz1";
        // ---

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // å…¨åŸŸè®Šæ•¸
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let events = []; // æœ¬åœ°äº‹ä»¶å¿«å– (ç”± Firebase åŒæ­¥)
        let editingEventId = null; // ç¾åœ¨å„²å­˜çš„æ˜¯ Firestore çš„ Document ID
        let editingGroupId = null; // (v1.6.0) æ­£åœ¨ç·¨è¼¯çš„äº‹ä»¶çµ„ ID
        let originalEventDate = null; // (v1.5.0) ç·¨è¼¯æ™‚åŸå§‹äº‹ä»¶æ—¥æœŸ (ç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç§»å‹•) - v1.6.0 å¯èƒ½ä¸å†éœ€è¦
        let selectedColor = '';
        let selectedEmoji = '';
        let currentUserId = null; // ç›®å‰ç™»å…¥çš„ä½¿ç”¨è€… ID
        let isAdmin = false; // æ˜¯å¦ç‚ºç®¡ç†å“¡
        let unsubscribeFromEvents = null; // ç”¨ä¾†å–æ¶ˆ Firestore ç›£è½

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // (v1.3.0) è¼‰å…¥å„²å­˜çš„ä¸»é¡Œ
            const savedTheme = localStorage.getItem('calendarTheme');
            if (savedTheme) {
                document.body.className = savedTheme;
            } else {
                document.body.className = 'theme-tech'; // é è¨­ä¸»é¡Œ
            }

            // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨
            initYearSelect();

            // è¨­å®šç•¶å‰æœˆä»½å’Œå¹´ä»½
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;

            // ç›£è½ Firebase é©—è­‰ç‹€æ…‹
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // ä½¿ç”¨è€…å·²ç™»å…¥
                    currentUserId = user.uid;
                    console.log("ç›®å‰ä½¿ç”¨è€… UID:", currentUserId); // æ–¹ä¾¿è¤‡è£½ UID

                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('userInfo').style.display = 'flex';
                    document.getElementById('userName').textContent = user.displayName || user.email;
                    document.getElementById('userPhoto').src = user.photoURL || 'https://placehold.co/40x40/cccccc/ffffff?text=User';

                    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                    if (currentUserId === ADMIN_UID) {
                        isAdmin = true;
                        document.getElementById('adminIndicator').style.display = 'inline-block';
                        // (v1.4.0) ç§»é™¤ç®¡ç†å“¡ç™»å…¥æˆåŠŸæç¤º
                        // showCustomAlert("ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼æ‚¨ç¾åœ¨å¯ä»¥ç·¨è¼¯äº‹ä»¶ã€‚");
                    } else {
                        isAdmin = false;
                        document.getElementById('adminIndicator').style.display = 'none';
                    }

                } else {
                    // ä½¿ç”¨è€…å·²ç™»å‡º
                    currentUserId = null;
                    isAdmin = false;
                    document.getElementById('loginBtn').style.display = 'block';
                    document.getElementById('userInfo').style.display = 'none';
                    document.getElementById('adminIndicator').style.display = 'none';
                }

                // ç™»å…¥ç‹€æ…‹æ”¹è®Šå¾Œï¼Œé‡æ–°æ¸²æŸ“è¡Œäº‹æ›†ä»¥æ›´æ–°æ¬Šé™å¤–è§€
                // (äº‹ä»¶è®€å–ä¸å—ç™»å…¥ç‹€æ…‹å½±éŸ¿)
                renderCalendar();
            });

            // è¼‰å…¥å…¬é–‹äº‹ä»¶ (ç„¡è«–æ˜¯å¦ç™»å…¥)
            loadEventsFromFirestore();

            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            setupEventListeners();
        });

        // ç¶å®šå…¨åŸŸå‡½å¼åˆ° window ç‰©ä»¶ï¼Œä»¥ä¾¿ HTML onclick å¯ä»¥å‘¼å«
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
                // ç‹€æ…‹è®Šæ›´å°‡ç”± onAuthStateChanged è™•ç†
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                showCustomAlert("Google ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å½ˆå‡ºè¦–çª—æ˜¯å¦è¢«é˜»æ“‹ã€‚");
            }
        };

        window.logout = async () => {
            // (v1.5.0) æ”¹ç”¨è‡ªè¨‚æç¤ºæ¡†ç¢ºèª
            showCustomConfirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', async () => {
                try {
                    await signOut(auth);
                    // ç‹€æ…‹è®Šæ›´å°‡ç”± onAuthStateChanged è™•ç†
                } catch (error) {
                    console.error("ç™»å‡ºå¤±æ•—:", error);
                }
            });
        };

        // å¾ Firestore è¼‰å…¥äº‹ä»¶ (è®€å–å…¬é–‹é›†åˆ)
        function loadEventsFromFirestore() {
            // å¦‚æœå·²æœ‰ç›£è½ï¼Œå…ˆå–æ¶ˆ
            if (unsubscribeFromEvents) {
                unsubscribeFromEvents();
            }

            // å»ºç«‹æŒ‡å‘ "å…¬é–‹äº‹ä»¶" é›†åˆçš„æŸ¥è©¢
            const eventsCollectionRef = collection(db, 'public_events');
            const q = query(eventsCollectionRef);

            // è¨­å®šå³æ™‚ç›£è½
            unsubscribeFromEvents = onSnapshot(q, (querySnapshot) => {
                events = []; // æ¸…ç©ºæœ¬åœ°å¿«å–
                querySnapshot.forEach((doc) => {
                    events.push({
                        id: doc.id, // å„²å­˜ Firestore Document ID
                        ...doc.data()
                    });
                });
                // é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†
                renderCalendar();
                // (v1.5.0) æ›´æ–°æœå°‹çµæœ (å¦‚æœé¢æ¿æ˜¯é–‹å•Ÿçš„)
                if (document.getElementById('searchResultsPanel').style.display === 'block') {
                    searchEvents();
                }
            }, (error) => {
                console.error("è¼‰å…¥å…¬é–‹äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showCustomAlert("ç„¡æ³•å¾é›²ç«¯è¼‰å…¥äº‹ä»¶ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¦å‰‡è¨­å®šã€‚");
            });
        }


        // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨
        function initYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            for (let year = 1950; year <= 2099; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // é¡è‰²é¸æ“‡å™¨
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                });
            });

            // è¡¨æƒ…ç¬¦è™Ÿé¸æ“‡å™¨
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEmoji = this.dataset.emoji;
                });
            });

            // è¡¨å–®æäº¤
            document.getElementById('eventForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEvent();
            });

            // (v1.6.0) ç§»é™¤é»æ“Š modal overlay é—œé–‰åŠŸèƒ½
            // document.getElementById('eventModal').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         closeModal();
            //     }
            // });
             // (v1.5.0 -> v1.6.0) è‡ªè¨‚åŒ¯å‡ºæ¨¡æ…‹æ¡† overlay é»æ“Š (ä¿ç•™)
            document.getElementById('customExportModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                    closeCustomExportModal();
                 }
            });
             // (v1.5.0 -> v1.6.0) è‡ªè¨‚æç¤ºæ¡† overlay é»æ“Š (ä¿ç•™)
             document.getElementById('alertModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     this.style.display = 'none';
                 }
             });
             // (v1.5.0 -> v1.6.0) è‡ªè¨‚ç¢ºèªæ¡† overlay é»æ“Š (ä¿ç•™)
             document.getElementById('confirmModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     this.style.display = 'none';
                 }
             });


            // é—œé–‰è‡ªè¨‚æç¤ºæ¡†æŒ‰éˆ•
            document.querySelectorAll('.close-alert').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('alertModal').style.display = 'none';
                });
            });

            // (v1.5.0) é—œé–‰è‡ªè¨‚ç¢ºèªæ¡†æŒ‰éˆ•
            document.querySelectorAll('.close-confirm').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('confirmModal').style.display = 'none';
                });
            });
            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                 document.getElementById('confirmModal').style.display = 'none';
            });


            // æ¨™é¡Œé»æ“Šäº‹ä»¶
            document.getElementById('calendarTitle').addEventListener('click', () => {
                window.open('https://key0208class.github.io/26005class-calendar/', '_blank');
            });

             // (v1.5.0) æœå°‹è¼¸å…¥è§¸ç™¼
             document.getElementById('searchInput').addEventListener('input', searchEvents);

             // (v1.5.0) é»æ“Šç©ºç™½è™•é—œé–‰æœå°‹çµæœ
             document.addEventListener('click', (e) => {
                const searchPanel = document.getElementById('searchResultsPanel');
                const searchInput = document.getElementById('searchInput');
                // (v1.6.0) ç¢ºä¿é»æ“Šæœå°‹çµæœé …ç›®æ™‚ä¸é—œé–‰
                if (searchPanel.style.display === 'block' && !searchPanel.contains(e.target) && e.target !== searchInput && !e.target.classList.contains('search-result-item')) {
                    searchPanel.style.display = 'none';
                    // (v1.6.0) æ¸…ç©ºæœå°‹æ¡†
                    searchInput.value = '';
                }
             });
        }

        // æ¸²æŸ“è¡Œäº‹æ›†
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');

            // æ¸…é™¤ç¾æœ‰çš„æ—¥æœŸæ ¼å­ï¼ˆä¿ç•™æ˜ŸæœŸæ¨™é¡Œï¼‰
            const dayHeaders = grid.querySelectorAll('.day-header');
            grid.innerHTML = '';
            dayHeaders.forEach(header => grid.appendChild(header));

            // è¨ˆç®—æœˆä»½çš„ç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();

            // è¨ˆç®—ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾ï¼ˆèª¿æ•´ç‚ºé€±ä¸€é–‹å§‹ï¼‰
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1;

            // æ·»åŠ ä¸Šå€‹æœˆçš„æ—¥æœŸ
            const prevMonth = new Date(currentYear, currentMonth, 0);
            const prevMonthDays = prevMonth.getDate();

            for (let i = startDay - 1; i >= 0; i--) {
                const dayCell = createDayCell(prevMonthDays - i, true, null);
                grid.appendChild(dayCell);
            }

            // æ·»åŠ ç•¶æœˆçš„æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayCell = createDayCell(day, false, dateStr);
                grid.appendChild(dayCell);
            }

            // æ·»åŠ ä¸‹å€‹æœˆçš„æ—¥æœŸä»¥å¡«æ»¿ç¶²æ ¼
            const targetCells = 35; // å›ºå®š 5 é€± (35 æ ¼) ä½ˆå±€
            const totalCells = grid.children.length - 7; // æ¸›å»æ˜ŸæœŸæ¨™é¡Œ
            let remainingCells = targetCells - totalCells;

            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = createDayCell(day, true, null);
                grid.appendChild(dayCell);
            }
        }

        // å‰µå»ºæ—¥æœŸæ ¼å­
        function createDayCell(day, isOtherMonth, dateStr) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (isOtherMonth) {
                cell.classList.add('other-month');
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
            const today = new Date();
            if (!isOtherMonth &&
                day === today.getDate() &&
                currentMonth === today.getMonth() &&
                currentYear === today.getFullYear()) {
                cell.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);

            // äº‹ä»¶å®¹å™¨
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'events-container';
            cell.appendChild(eventsContainer);


            // æ·»åŠ è©²æ—¥æœŸçš„äº‹ä»¶
            if (!isOtherMonth && dateStr) {
                const dayEvents = events.filter(event => event.date === dateStr);

                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    // (v1.4.0) è™•ç† 'ç„¡' é¡è‰²çš„æƒ…æ³
                    eventElement.className = `event-item ${event.color ? 'event-' + event.color : 'event-none'}`;
                    // (v1.6.0) æ·»åŠ  data-event-id ä»¥ä¾¿æœå°‹é»æ“Šå®šä½
                    eventElement.dataset.eventId = event.id;
                    // ç¢ºä¿ event.title ä¸æ˜¯ undefined æˆ– null
                    const title = event.title || 'ç„¡æ¨™é¡Œ';
                    eventElement.textContent = `${event.emoji || 'â—'} ${title}`;
                    eventElement.onclick = (e) => {
                        e.stopPropagation();
                        // (v1.5.0) å‚³éé»æ“Šçš„å…ƒç´ ï¼Œç”¨æ–¼å®šä½ (é›–ç„¶ç¾åœ¨å›ºå®šä¸­é–“äº†)
                        showStickyNote(event, e.currentTarget);
                    };
                    eventsContainer.appendChild(eventElement);
                });

                // (v1.3.0) é»æ“Šæ—¥æœŸ "æ•¸å­—" æ–°å¢äº‹ä»¶ (åƒ…é™ç®¡ç†å“¡)
                dayNumber.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¸ç™¼åˆ° sticky note çš„é—œé–‰äº‹ä»¶
                    if (isAdmin) {
                        openEventModal(dateStr);
                    }
                    // (v1.3.0) ä¸€èˆ¬ä½¿ç”¨è€…é»æ“Šç„¡åæ‡‰ï¼Œä¸è·³æç¤º
                };

                // (v1.3.0) é»æ“Šæ–¹æ ¼ç©ºç™½è™•ç„¡ä»»ä½•å‹•ä½œ (å·²ç§»é™¤ cell.onclick)

            } else if (isOtherMonth) {
                // (éœ€æ±‚ä¿®æ”¹) è®“æ•¸å­—ä¹Ÿå¯ä»¥é»æ“Š
                dayNumber.onclick = (e) => { e.stopPropagation(); };
            }

            return cell;
        }

        // é–‹å•Ÿäº‹ä»¶æ¨¡æ…‹æ¡† (v1.6.0 èª¿æ•´ä»¥è™•ç† groupId)
        window.openEventModal = (dateOrEventDate, event = null) => {
            // æ¬Šé™æª¢æŸ¥
            if (!isAdmin) {
                showCustomAlert("æ‚¨æ²’æœ‰ç·¨è¼¯æ¬Šé™ã€‚");
                return;
            }

            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteBtn');
            const saveBtn = document.getElementById('saveBtn');
            const startDateInput = document.getElementById('eventStartDate');
            const endDateInput = document.getElementById('eventEndDate');

            if (event) {
                // --- ç·¨è¼¯æ¨¡å¼ ---
                modalTitle.textContent = 'âœï¸ ç·¨è¼¯äº‹ä»¶';
                editingEventId = event.id; // å„²å­˜ç•¶å‰é»æ“Šäº‹ä»¶çš„ ID
                editingGroupId = event.groupId || null; // (v1.6.0) å„²å­˜çµ„ ID

                document.getElementById('eventTitle').value = event.title || '';
                document.getElementById('eventContent').value = event.content || '';
                selectedColor = event.color || '';
                selectedEmoji = event.emoji || '';
                deleteBtn.style.display = 'inline-block';

                // (v1.6.0) è¨­å®šé–‹å§‹å’ŒçµæŸæ—¥æœŸï¼Œå„ªå…ˆä½¿ç”¨äº‹ä»¶æœ¬èº«çš„ startDate/endDate
                // è‹¥ç„¡ï¼Œå‰‡è¡¨ç¤ºæ˜¯èˆŠè³‡æ–™æˆ–å–®æ—¥äº‹ä»¶ï¼Œä½¿ç”¨ event.date
                startDateInput.value = event.startDate || event.date;
                endDateInput.value = event.endDate || event.date;


                // (v1.4.0) è¨­å®šé¸ä¸­çš„é¡è‰²
                document.querySelectorAll('.color-option').forEach(o => {
                    o.classList.toggle('selected', o.dataset.color === selectedColor);
                });
                document.querySelectorAll('.emoji-option').forEach(o => {
                    o.classList.toggle('selected', o.dataset.emoji === selectedEmoji);
                });
            } else {
                // --- æ–°å¢æ¨¡å¼ ---
                modalTitle.textContent = 'ğŸ“ æ–°å¢äº‹ä»¶';
                document.getElementById('eventForm').reset(); // é‡è¨­è¡¨å–®
                selectedColor = ''; // é è¨­ç‚º 'ç„¡'
                selectedEmoji = '';
                editingEventId = null;
                editingGroupId = null; // (v1.6.0) æ–°å¢äº‹ä»¶ç„¡çµ„ ID
                deleteBtn.style.display = 'none';

                 // (v1.5.0) è¨­å®šé–‹å§‹å’ŒçµæŸæ—¥æœŸç‚ºé»æ“Šçš„æ—¥æœŸ (dateOrEventDate)
                startDateInput.value = dateOrEventDate;
                endDateInput.value = dateOrEventDate;

                // (v1.4.0) æ¸…é™¤é¸æ“‡ (ä¸¦é é¸ 'ç„¡')
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                document.querySelector('.color-option[data-color=""]').classList.add('selected');
                document.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
            }

            // é¡¯ç¤ºå„²å­˜å’Œåˆªé™¤æŒ‰éˆ•
            deleteBtn.style.display = event ? 'inline-block' : 'none';
            saveBtn.style.display = 'inline-block';

            modal.style.display = 'block';
        }


        // é—œé–‰æ¨¡æ…‹æ¡†
        window.closeModal = () => {
            document.getElementById('eventModal').style.display = 'none';
        }

        // (v1.5.0) Helper: æ—¥æœŸè¿­ä»£å™¨
        function* dateRange(start, end) {
            let current = new Date(start);
            const endDate = new Date(end);
             // æ ¡æ­£é–‹å§‹å’ŒçµæŸæ—¥æœŸçš„æ™‚å€åç§»
             current.setMinutes(current.getMinutes() + current.getTimezoneOffset());
             endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());

            while (current <= endDate) {
                yield new Date(current); // Yield a copy
                current.setDate(current.getDate() + 1);
            }
        }

        // (v1.6.0) Helper: ç”¢ç”Ÿå”¯ä¸€çš„ Group ID
        function generateGroupId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }


        // å„²å­˜äº‹ä»¶ (è‡³ Firebase) - (v1.6.0 é‡æ§‹ä»¥è™•ç† groupId)
        async function saveEvent() {
            // æ¬Šé™æª¢æŸ¥
            if (!isAdmin) {
                showCustomAlert("æ‚¨æ²’æœ‰å„²å­˜æ¬Šé™ï¼");
                return;
            }

            const title = document.getElementById('eventTitle').value.trim();
            const content = document.getElementById('eventContent').value.trim();
            const startDateStr = document.getElementById('eventStartDate').value;
            const endDateStr = document.getElementById('eventEndDate').value;

            if (!title) {
                showCustomAlert('è«‹è¼¸å…¥äº‹ä»¶æ¨™é¡Œï¼');
                return;
            }
            if (!startDateStr || !endDateStr) {
                showCustomAlert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸï¼');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

             // æ ¡æ­£æ™‚å€å•é¡Œå†æ¯”è¼ƒ
             const compareStartDate = new Date(startDate);
             const compareEndDate = new Date(endDate);
             compareStartDate.setMinutes(compareStartDate.getMinutes() + compareStartDate.getTimezoneOffset());
             compareEndDate.setMinutes(compareEndDate.getMinutes() + compareEndDate.getTimezoneOffset());

            if (compareStartDate > compareEndDate) {
                showCustomAlert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼');
                return;
            }

            // ç”¢ç”Ÿæœ¬æ¬¡å„²å­˜çš„äº‹ä»¶åŸºç¤è³‡æ–™
            const eventBaseData = {
                title: title,
                content: content,
                color: selectedColor,
                emoji: selectedEmoji,
                startDate: startDateStr, // (v1.6.0) å„²å­˜ç¯„åœæ—¥æœŸ
                endDate: endDateStr,   // (v1.6.0) å„²å­˜ç¯„åœæ—¥æœŸ
                groupId: editingGroupId || generateGroupId() // (v1.6.0) ä½¿ç”¨ç¾æœ‰ ID æˆ–ç”¢ç”Ÿæ–° ID
            };

            const batch = writeBatch(db);
            const eventsCollectionRef = collection(db, 'public_events');

            try {
                // --- è™•ç†ç·¨è¼¯æƒ…æ³ï¼šåˆªé™¤èˆŠçµ„çš„æ‰€æœ‰äº‹ä»¶ ---
                if (editingGroupId) {
                    const q = query(eventsCollectionRef, where("groupId", "==", editingGroupId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref); // å°‡èˆŠçµ„çš„æ‰€æœ‰æ–‡ä»¶åŠ å…¥åˆªé™¤æ‰¹æ¬¡
                    });
                }
                // --- èˆŠè³‡æ–™è™•ç† (ç„¡ groupId ä½†æœ‰ editingEventId) ---
                // å¦‚æœæ˜¯ç·¨è¼¯ä¸€å€‹æ²’æœ‰ groupId çš„èˆŠäº‹ä»¶ï¼Œä¹Ÿéœ€è¦åˆªé™¤å®ƒ
                else if (editingEventId) {
                     const oldDocRef = doc(db, 'public_events', editingEventId);
                     batch.delete(oldDocRef);
                }


                // --- æ–°å¢äº‹ä»¶ (å¯èƒ½æ˜¯å–®æ—¥æˆ–å¤šæ—¥) ---
                for (const date of dateRange(startDateStr, endDateStr)) { // ä½¿ç”¨å­—ä¸²é¿å… dateRange å…§éƒ¨æ™‚å€å•é¡Œ
                    const dateStr = formatDateYYYYMMDD(date);
                    const newDocRef = doc(eventsCollectionRef); // ç‚ºæ¯å€‹æ—¥æœŸå‰µå»ºæ–°æ–‡ä»¶
                    batch.set(newDocRef, {
                        ...eventBaseData,
                        date: dateStr // ç‰¹å®šæ—¥æœŸçš„äº‹ä»¶
                    });
                }

                // åŸ·è¡Œæ‰¹æ¬¡æ“ä½œ
                await batch.commit();

                closeModal();
                // (v1.6.0) ç§»é™¤å„²å­˜æç¤º
                // showCustomAlert('äº‹ä»¶å·²å„²å­˜ï¼');
                // onSnapshot æœƒè‡ªå‹•è§¸ç™¼ä¸¦æ›´æ–°ä»‹é¢

            } catch (error) {
                console.error("å„²å­˜äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showCustomAlert("å„²å­˜äº‹ä»¶å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase è¦å‰‡æˆ–ç¶²è·¯é€£ç·šã€‚");
            }
        }


        // åˆªé™¤äº‹ä»¶ (å¾ Firebase) - (v1.6.0 èª¿æ•´ä»¥è™•ç† groupId)
        window.deleteEvent = async () => {
            // æ¬Šé™æª¢æŸ¥
            if (!isAdmin || !editingEventId) { // ä»éœ€ editingEventId ä¾†è§¸ç™¼
                showCustomAlert("æ‚¨æ²’æœ‰åˆªé™¤æ¬Šé™ï¼");
                return;
            }

            // å–å¾—è¦åˆªé™¤çš„äº‹ä»¶çš„ groupId (å¦‚æœæœ‰çš„è©±)
            const eventToDelete = events.find(e => e.id === editingEventId);
            const groupIdToDelete = eventToDelete?.groupId;

            const confirmMessage = groupIdToDelete
                ? 'ç¢ºå®šè¦åˆªé™¤é€™å€‹é€£çºŒäº‹ä»¶çš„æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿ'
                : 'ç¢ºå®šè¦åˆªé™¤é€™å€‹äº‹ä»¶å—ï¼Ÿ';

            showCustomConfirm(confirmMessage, async () => {
                 try {
                    const batch = writeBatch(db);
                    const eventsCollectionRef = collection(db, 'public_events');

                    if (groupIdToDelete) {
                        // åˆªé™¤æ•´å€‹çµ„
                        const q = query(eventsCollectionRef, where("groupId", "==", groupIdToDelete));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                    } else {
                        // åªåˆªé™¤å–®å€‹ (èˆŠè³‡æ–™)
                        const eventDocRef = doc(db, 'public_events', editingEventId);
                        batch.delete(eventDocRef);
                    }

                    await batch.commit();
                    closeModal();
                    // onSnapshot æœƒè‡ªå‹•è§¸ç™¼ä¸¦æ›´æ–°ä»‹é¢
                 } catch (error) {
                    console.error("åˆªé™¤äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    showCustomAlert("åˆªé™¤äº‹ä»¶å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
                 }
            });
        }

        // é¡¯ç¤ºä¾¿åˆ©è²¼ (v1.6.0 åŠ å…¥æ—¥æœŸç¯„åœé¡¯ç¤º)
        function showStickyNote(event, targetElement) {
            // ç§»é™¤ç¾æœ‰çš„ä¾¿åˆ©è²¼
            document.querySelectorAll('.sticky-note').forEach(note => note.remove());

            const stickyNote = document.createElement('div');
            stickyNote.className = 'sticky-note';

            // è½‰ç¾© event ç‰©ä»¶ä»¥ä¾¿å®‰å…¨å‚³é
            const eventJson = JSON.stringify(event).replace(/'/g, "\\'").replace(/"/g, '&quot;');

            // æ ¹æ“šæ˜¯å¦ç‚ºç®¡ç†å“¡æ±ºå®šæ˜¯å¦é¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•
            const editButtonHtml = isAdmin ?
                `<button class="sticky-note-btn" onclick='window.editEventFromSticky(${eventJson})'>âœï¸</button>` : '';

            // (v1.6.0) æº–å‚™æ—¥æœŸé¡¯ç¤ºå­—ä¸²
            let dateDisplay = event.date; // é è¨­é¡¯ç¤ºç•¶å¤©
            if (event.startDate && event.endDate) {
                 if (event.startDate === event.endDate) {
                     dateDisplay = event.startDate;
                 } else {
                     dateDisplay = `${event.startDate} ~ ${event.endDate}`;
                 }
            }


            stickyNote.innerHTML = `
                <div class="sticky-note-header">
                    <span>${event.emoji || 'ğŸ“'} ${event.title || 'ç„¡æ¨™é¡Œ'}</span>
                    <div class="sticky-note-controls">
                        ${editButtonHtml}
                        <button class="sticky-note-close" onclick="this.closest('.sticky-note').remove()">Ã—</button>
                    </div>
                </div>
                <div class="sticky-note-content">${event.content || 'ç„¡å…§å®¹'}</div>
                <!-- (v1.6.0) æ–°å¢æ—¥æœŸé¡¯ç¤ºå€åŸŸ -->
                <div class="sticky-note-footer">
                    ğŸ—“ï¸ ${dateDisplay}
                </div>
            `;

            // (v1.5.0) å®šä½åœ¨è¢å¹•ä¸­é–“
            stickyNote.style.position = 'fixed';
            stickyNote.style.left = '50%';
            stickyNote.style.top = '50%';
            stickyNote.style.transform = 'translate(-50%, -50%)'; // CSS ç½®ä¸­

            // æ·»åŠ æ‹–æ›³åŠŸèƒ½
            makeDraggable(stickyNote);

            document.body.appendChild(stickyNote);
        }


        // å¾ä¾¿åˆ©è²¼ç·¨è¼¯
        window.editEventFromSticky = (event) => {
            // event ç‰©ä»¶ç¾åœ¨åŒ…å«äº† Firestore 'id'
            document.querySelectorAll('.sticky-note').forEach(note => note.remove());
            // (v1.6.0) å‚³é event ç‰©ä»¶æœ¬èº«ï¼Œè€Œä¸æ˜¯ event.date
            openEventModal(event.date, event); // date åƒæ•¸ç¾åœ¨ä¸»è¦ç”¨æ–¼æ–°å¢
        };


        // ä½¿å…ƒç´ å¯æ‹–æ›³ (v1.5.0 ä¿®æ­£æ‹–æ›³è·³å‹•å•é¡Œ)
        function makeDraggable(element) {
            let initialTop, initialLeft, offsetX, offsetY;
            let isDragging = false; // è¿½è¹¤æ˜¯å¦æ­£åœ¨æ‹–æ›³

            // å„ªå…ˆå¾ header æ‹–æ›³
            const header = element.querySelector('.sticky-note-header');
            (header || element).onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();

                // ç²å–åˆå§‹ä½ç½® (ç›¸å°æ–¼ viewport)
                const rect = element.getBoundingClientRect();
                initialTop = rect.top;
                initialLeft = rect.left;

                // è¨ˆç®—æ»‘é¼ é»æ“Šä½ç½®ç›¸å°æ–¼å…ƒç´ å·¦ä¸Šè§’çš„åç§»
                offsetX = e.clientX - initialLeft;
                offsetY = e.clientY - initialTop;

                // è¨­ç½®å…ƒç´ çš„ top å’Œ leftï¼Œä¸¦ç§»é™¤ transform
                // é€™æ¨£æ‹–æ›³æ™‚å°±ç›´æ¥æ“ä½œ top/left
                element.style.transform = 'none'; // é‡è¦ï¼šç§»é™¤ transform ä»¥ä¾¿ top/left ç”Ÿæ•ˆ
                element.style.top = initialTop + "px";
                element.style.left = initialLeft + "px";

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                isDragging = true;
            }

            function elementDrag(e) {
                if (!isDragging) return; // ç¢ºä¿åªæœ‰åœ¨ mousedown å¾Œæ‰åŸ·è¡Œ

                e = e || window.event;
                e.preventDefault();

                // è¨ˆç®—æ–°çš„ top å’Œ left
                let newTop = e.clientY - offsetY;
                let newLeft = e.clientX - offsetX;

                // ç¢ºä¿ä¸æœƒæ‹–å‡ºè¦–çª—å¤–
                newTop = Math.max(0, Math.min(newTop, window.innerHeight - element.offsetHeight));
                newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - element.offsetWidth));

                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                isDragging = false; // åœæ­¢æ‹–æ›³
            }
        }


        // å°èˆªåŠŸèƒ½
        window.previousMonth = () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateSelectors();
            renderCalendar();
        }

        window.nextMonth = () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateSelectors();
            renderCalendar();
        }

        window.changeMonth = () => {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            renderCalendar();
        }

        window.changeYear = () => {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            renderCalendar();
        }

        window.goToToday = () => {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            updateSelectors();
            renderCalendar();
        }

        function updateSelectors() {
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
        }

        // (v1.5.0) æœå°‹åŠŸèƒ½å¯¦ä½œ
        window.searchEvents = () => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsPanel = document.getElementById('searchResultsPanel');
            resultsPanel.innerHTML = ''; // æ¸…ç©ºèˆŠçµæœ

            if (searchTerm === '') {
                resultsPanel.style.display = 'none'; // éš±è—é¢æ¿
                // (v1.6.0) ç§»é™¤ body class æ§åˆ¶
                // document.body.classList.remove('search-panel-visible');
                return;
            }
             // (v1.6.0) ç§»é™¤ body class æ§åˆ¶
             // document.body.classList.add('search-panel-visible');

            const matchedEvents = events.filter(event =>
                event.title && event.title.toLowerCase().includes(searchTerm)
            );

            // (v1.5.0) ä¾æ—¥æœŸæ’åºçµæœ
            matchedEvents.sort((a, b) => a.date.localeCompare(b.date));

            // (v1.6.0) éæ¿¾é‡è¤‡çš„ groupIdï¼Œåªé¡¯ç¤ºæ¯å€‹é€£çºŒäº‹ä»¶ä¸€æ¬¡
            const uniqueGroupEvents = [];
            const processedGroupIds = new Set();
            matchedEvents.forEach(event => {
                if (event.groupId) {
                    if (!processedGroupIds.has(event.groupId)) {
                        uniqueGroupEvents.push(event); // åªåŠ å…¥ç¬¬ä¸€å€‹æ‰¾åˆ°çš„
                        processedGroupIds.add(event.groupId);
                    }
                } else {
                    uniqueGroupEvents.push(event); // æ²’æœ‰ groupId çš„å–®ç¨äº‹ä»¶ç›´æ¥åŠ å…¥
                }
            });


            if (uniqueGroupEvents.length > 0) {
                uniqueGroupEvents.forEach(event => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    // (v1.6.0) é¡¯ç¤ºæ—¥æœŸæˆ–æ—¥æœŸç¯„åœ
                    let dateText = event.startDate && event.endDate && event.startDate !== event.endDate
                                   ? `${event.startDate}~${event.endDate}`
                                   : event.date;
                    item.textContent = `${dateText} - ${event.title}`;
                    item.onclick = () => {
                        // 1. è·³è½‰æ—¥æœŸ (è·³è½‰åˆ°äº‹ä»¶çš„ start date æˆ– date)
                        const jumpToDate = new Date(event.startDate || event.date);
                         jumpToDate.setMinutes(jumpToDate.getMinutes() + jumpToDate.getTimezoneOffset()); // æ ¡æ­£æ™‚å€

                        currentYear = jumpToDate.getFullYear();
                        currentMonth = jumpToDate.getMonth();
                        updateSelectors();
                        renderCalendar(); // é‡æ–°æ¸²æŸ“æ—¥æ›†ä»¥é¡¯ç¤ºæ­£ç¢ºæœˆä»½

                        // 2. é¡¯ç¤ºä¾¿åˆ©è²¼
                         setTimeout(() => {
                             showStickyNote(event, null); // å‚³éåŸå§‹äº‹ä»¶ç‰©ä»¶
                         }, 100);


                        // 3. é—œé–‰æœå°‹é¢æ¿
                        resultsPanel.style.display = 'none';
                        document.getElementById('searchInput').value = ''; // æ¸…ç©ºæœå°‹æ¡†
                        // (v1.6.0) ç§»é™¤ body class æ§åˆ¶
                        // document.body.classList.remove('search-panel-visible');
                    };
                    resultsPanel.appendChild(item);
                });
                resultsPanel.style.display = 'block'; // é¡¯ç¤ºé¢æ¿
            } else {
                const noResult = document.createElement('div');
                noResult.className = 'search-no-result';
                noResult.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆçš„äº‹ä»¶';
                resultsPanel.appendChild(noResult);
                resultsPanel.style.display = 'block'; // é¡¯ç¤ºé¢æ¿
            }
        }


        // ä¸»é¡Œåˆ‡æ›
        window.changeTheme = (theme) => {
            // (v1.3.0) çµ±ä¸€ theme è®Šæ•¸ç‚º class åç¨±
            const themeClassName = `theme-${theme}`;
            document.body.className = themeClassName;
            // (v1.3.0) å„²å­˜ä¸»é¡Œåå¥½
            localStorage.setItem('calendarTheme', themeClassName);
        }

        // è¨­å®šé¢æ¿
        window.toggleSettings = () => {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        // (v1.3.0) åŒ¯å‡ºåŠŸèƒ½ (ä¾ç•¶å‰é é¢åŒ¯å‡º)
        window.exportData = (type) => {
            if (!isAdmin) {
                showCustomAlert("åƒ…é™ç®¡ç†å“¡æ‰èƒ½åŒ¯å‡ºè³‡æ–™ï¼");
                return;
            }
            // 'events' é™£åˆ—å·²ç”± onSnapshot åŒæ­¥ï¼Œç›´æ¥ä½¿ç”¨å³å¯
            let dataToExport = [];
            const now = new Date();

            switch(type) {
                case 'all':
                    dataToExport = events;
                    break;
                case 'year':
                    // (v1.3.0) ä¾æ“š currentYear åŒ¯å‡º
                    dataToExport = events.filter(event => {
                        const eventYear = new Date(event.date).getFullYear();
                        return eventYear === currentYear;
                    });
                    break;
                case 'month':
                    // (v1.3.0) ä¾æ“š currentYear å’Œ currentMonth åŒ¯å‡º
                    dataToExport = events.filter(event => {
                        const eventDate = new Date(event.date);
                         eventDate.setMinutes(eventDate.getMinutes() + eventDate.getTimezoneOffset()); // æ ¡æ­£æ™‚å€
                        return eventDate.getFullYear() === currentYear &&
                               eventDate.getMonth() === currentMonth;
                    });
                    break;
            }

            // ç§»é™¤ Firestore 'id'ï¼Œé¿å…åŒ¯å…¥æ™‚æ··æ·†
            const cleanDataToExport = dataToExport.map(({ id, ...rest }) => rest);

            const exportFile = {
                exportDate: now.toISOString(),
                type: type,
                events: cleanDataToExport
            };

            downloadJson(exportFile, `ç­ç´šè¡Œäº‹æ›†_${type}_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.json`);
        }

        // (v1.3.0) æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
        function formatDateYYYYMMDD(date) {
            const d = new Date(date); // ç¢ºä¿æ˜¯ Date ç‰©ä»¶
             d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); // åå‘æ ¡æ­£ä»¥å¾—åˆ°æ­£ç¢ºçš„ YYYY-MM-DD
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // (v1.3.0) é–‹å•Ÿè‡ªè¨‚åŒ¯å‡ºæ¨¡æ…‹æ¡†
        window.openCustomExportModal = () => {
            if (!isAdmin) {
                showCustomAlert("åƒ…é™ç®¡ç†å“¡æ‰èƒ½åŒ¯å‡ºè³‡æ–™ï¼");
                return;
            }

            // (v1.3.0) é è¨­æ—¥æœŸï¼šçµæŸç‚ºä»Šå¤©ï¼Œé–‹å§‹ç‚ºä¸€å€‹æœˆå‰
            const endDate = new Date(); // ä½¿ç”¨ä»Šå¤©
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1); // å¾€å‰æ¨ä¸€å€‹æœˆ

            document.getElementById('exportStartDate').value = formatDateYYYYMMDD(startDate);
            document.getElementById('exportEndDate').value = formatDateYYYYMMDD(endDate);

            document.getElementById('customExportModal').style.display = 'block';
        }

        // (v1.3.0) é—œé–‰è‡ªè¨‚åŒ¯å‡ºæ¨¡æ…‹æ¡†
        window.closeCustomExportModal = () => {
            document.getElementById('customExportModal').style.display = 'none';
        }

        // (v1.3.0) åŒ¯å‡ºè‡ªè¨‚ç¯„åœ (å¾æ¨¡æ…‹æ¡†è®€å–)
        window.exportCustomRange = () => {
            if (!isAdmin) {
                showCustomAlert("åƒ…é™ç®¡ç†å“¡æ‰èƒ½åŒ¯å‡ºè³‡æ–™ï¼");
                return;
            }
            // å¾æ¨¡æ…‹æ¡†è®€å–æ—¥æœŸ
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            if (startDate && endDate && endDate >= startDate) {
                const dataToExport = events.filter(event => {
                    return event.date >= startDate && event.date <= endDate;
                });

                // ç§»é™¤ Firestore 'id'
                const cleanDataToExport = dataToExport.map(({ id, ...rest }) => rest);

                const exportFile = {
                    exportDate: new Date().toISOString(),
                    type: 'custom',
                    dateRange: { start: startDate, end: endDate },
                    events: cleanDataToExport
                };

                downloadJson(exportFile, `ç­ç´šè¡Œäº‹æ›†_è‡ªè¨‚ç¯„åœ_${startDate}_${endDate}.json`);
                closeCustomExportModal(); // åŒ¯å‡ºå¾Œé—œé–‰
            } else {
                showCustomAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸç¯„åœï¼ (çµæŸæ—¥æœŸå¿…é ˆå¤§æ–¼æˆ–ç­‰æ–¼é–‹å§‹æ—¥æœŸ)');
            }
        }

        // (v1.3.0) èˆŠçš„ exportCustomRange (promptç‰ˆæœ¬) å·²è¢«ç§»é™¤

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }


        // (v1.6.0) åŒ¯å…¥åŠŸèƒ½ (ä½¿ç”¨è‡ªè¨‚ç¢ºèªæ¡†é¸æ“‡æ¨¡å¼)
        window.importData = async () => {
            if (!isAdmin) {
                showCustomAlert("åƒ…é™ç®¡ç†å“¡æ‰èƒ½åŒ¯å…¥è³‡æ–™ï¼");
                return;
            }

            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                showCustomAlert('è«‹é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆï¼');
                return;
            }

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                if (importData.events && Array.isArray(importData.events)) {

                    const eventsCollectionRef = collection(db, 'public_events');
                    const eventsToImport = importData.events;

                    // ä½¿ç”¨è‡ªè¨‚ç¢ºèªæ¡†è©¢å•æ¨¡å¼
                    showCustomConfirm(
                        `åµæ¸¬åˆ° ${eventsToImport.length} å€‹äº‹ä»¶ã€‚\nè«‹é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š\n\n[æ–°å¢] ä¿ç•™ç¾æœ‰äº‹ä»¶ï¼Œç›´æ¥åŠ å…¥æ–°äº‹ä»¶ã€‚\n[è¦†è“‹] åˆªé™¤åŒ¯å…¥æª”æ¡ˆä¸­æ¶‰åŠæ—¥æœŸçš„"æ‰€æœ‰"ç¾æœ‰äº‹ä»¶å¾Œï¼Œå†åŠ å…¥æ–°äº‹ä»¶ã€‚`,
                        async (choice) => { // å›èª¿å‡½æ•¸æ¥æ”¶ 'confirm' (è¦†è“‹) æˆ– 'cancel' (æ–°å¢)
                            let importMode = (choice === 'confirm') ? "2" : "1"; // confirm å°æ‡‰è¦†è“‹ '2'

                            const actionText = (importMode === "2") ? "è¦†è“‹" : "æ–°å¢";
                            const confirmMessage = (importMode === "2")
                                ? `âš ï¸ ç¢ºå®šè¦ "${actionText}" ${eventsToImport.length} å€‹äº‹ä»¶å—ï¼Ÿ\né€™å°‡æœƒ "åˆªé™¤" åŒ¯å…¥æª”æ¡ˆä¸­æ‰€æœ‰æ¶‰åŠæ—¥æœŸçš„ "å…¨éƒ¨" ç¾æœ‰äº‹ä»¶ï¼\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`
                                : `ç¢ºå®šè¦ "${actionText}" ${eventsToImport.length} å€‹äº‹ä»¶å—ï¼Ÿ`;

                             // å†æ¬¡ç¢ºèªæ“ä½œ
                            showCustomConfirm(confirmMessage, async (finalChoice) => {
                                if (finalChoice === 'confirm') {
                                    try {
                                        if (importMode === "1") {
                                            // æ¨¡å¼ 1ï¼šå…¨éƒ¨æ–°å¢
                                            const importPromises = [];
                                            for (const eventData of eventsToImport) {
                                                const { id, ...newEventData } = eventData;
                                                 // (v1.6.0) åŒ¯å…¥æ™‚ä¹ŸåŠ ä¸Š groupId, startDate, endDate
                                                 const newGroupId = generateGroupId();
                                                 const eventDate = newEventData.date || null; // Assume single day if no range
                                                 newEventData.groupId = newGroupId;
                                                 newEventData.startDate = eventDate;
                                                 newEventData.endDate = eventDate;

                                                if (newEventData.title && newEventData.date) {
                                                    importPromises.push(addDoc(eventsCollectionRef, newEventData));
                                                }
                                            }
                                            await Promise.all(importPromises);
                                            showCustomAlert('æ–°å¢åŒ¯å…¥å®Œæˆï¼');

                                        } else if (importMode === "2") {
                                            // æ¨¡å¼ 2ï¼šè¦†è“‹
                                            const datesToOverwrite = new Set(eventsToImport.map(e => e.date).filter(date => date)); // éæ¿¾æ‰ undefined çš„æ—¥æœŸ
                                            const eventsToDelete = events.filter(e => datesToOverwrite.has(e.date));

                                            const batch = writeBatch(db);

                                            eventsToDelete.forEach(e => {
                                                const docRef = doc(db, 'public_events', e.id);
                                                batch.delete(docRef);
                                            });

                                            eventsToImport.forEach(eventData => {
                                                const { id, ...newEventData } = eventData;
                                                 // (v1.6.0) åŒ¯å…¥æ™‚ä¹ŸåŠ ä¸Š groupId, startDate, endDate
                                                 const newGroupId = generateGroupId();
                                                 const eventDate = newEventData.date || null; // Assume single day if no range
                                                 newEventData.groupId = newGroupId;
                                                 newEventData.startDate = eventDate;
                                                 newEventData.endDate = eventDate;

                                                if (newEventData.title && newEventData.date) {
                                                    const newDocRef = doc(eventsCollectionRef);
                                                    batch.set(newDocRef, newEventData);
                                                }
                                            });

                                            await batch.commit();
                                            showCustomAlert('è¦†è“‹åŒ¯å…¥å®Œæˆï¼');
                                        }
                                        fileInput.value = ''; // æ¸…ç©ºé¸æ“‡çš„æ–‡ä»¶
                                    } catch (batchError) {
                                         console.error('æ‰¹æ¬¡åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', batchError);
                                        showCustomAlert('åŒ¯å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š' + batchError.message);
                                    }

                                } else {
                                    showCustomAlert('å·²å–æ¶ˆåŒ¯å…¥ã€‚');
                                    fileInput.value = '';
                                }
                            });


                        },
                        "é¸æ“‡åŒ¯å…¥æ¨¡å¼", // æ¨™é¡Œ
                        "è¦†è“‹",       // ç¢ºèªæŒ‰éˆ•æ–‡å­— (å°æ‡‰ 'confirm' å›èª¿å€¼)
                        "æ–°å¢"        // å–æ¶ˆæŒ‰éˆ•æ–‡å­— (å°æ‡‰ 'cancel' å›èª¿å€¼)
                    );


                } else {
                    showCustomAlert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼');
                }
            } catch (error) {
                console.error('è®€å–æˆ–è§£æåŒ¯å…¥æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                showCustomAlert('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }
// --- (v1.7.0) AI è¾¨è­˜è¼”åŠ©å·¥å…·å‡½å¼ ---

        // é–‹å•Ÿ AI è¼”åŠ© Modal
        // é–‹å•Ÿ AI è¼”åŠ© Modal (v1.8.0 ç§»é™¤ç®¡ç†å“¡æª¢æŸ¥ï¼Œä¸¦åŠ å…¥è®€å– Key)
        window.openAiHelperModal = () => {
            // (v1.8.0) æ¬Šé™æª¢æŸ¥å·²ç§»é™¤
            // if (!isAdmin) {
            //     showCustomAlert("åƒ…é™ç®¡ç†å“¡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
            //     return;
            // }

            // (v1.8.0) è¼‰å…¥å„²å­˜çš„ API Key
            const savedKey = localStorage.getItem('calendarAiApiKey');
            if (savedKey) {
                document.getElementById('aiApiKeyInput').value = savedKey;
                userAiApiKey = savedKey; // (v1.8.0) åŒæ­¥æ›´æ–°åˆ°å…¨åŸŸè®Šæ•¸
            }
            document.getElementById('aiHelperModal').style.display = 'block';

            // (v1.8.0) ç¶å®šæ‹–æ›³å€äº‹ä»¶ (å»¶é²ä¸€é»ç¶å®šï¼Œç¢ºä¿ modal å·²é¡¯ç¤º)
            setTimeout(setupAiDragDrop, 50); 
        }

        // é—œé–‰ AI è¼”åŠ© Modal
        window.closeAiHelperModal = () => {
            document.getElementById('aiHelperModal').style.display = 'none';
        }

        // (v1.8.0) å…¨åŸŸè®Šæ•¸ï¼Œå„²å­˜ä¸Šå‚³çš„æª”æ¡ˆ (åƒè€ƒ é›²æ•™å®¤é¡Œç›®ç”Ÿæˆå™¨)
        let aiUploadedFiles = []; 
        let userAiApiKey = ''; // (v1.8.0) å„²å­˜ä½¿ç”¨è€…è¼¸å…¥çš„ Key

        // (v1.8.0) å„²å­˜ä½¿ç”¨è€…è¼¸å…¥çš„ API Key
        window.saveAiApiKey = () => {
            const keyInput = document.getElementById('aiApiKeyInput');
            const key = keyInput.value.trim();
            if (key) {
                localStorage.setItem('calendarAiApiKey', key);
                userAiApiKey = key; // æ›´æ–°å…¨åŸŸè®Šæ•¸
                showCustomAlert('API é‡‘é‘°å·²æˆåŠŸå„²å­˜è‡³æ‚¨çš„ç€è¦½å™¨ï¼');
            } else {
                localStorage.removeItem('calendarAiApiKey');
                userAiApiKey = '';
                showCustomAlert('API é‡‘é‘°å·²æ¸…é™¤ã€‚');
            }
        }

        // (v1.8.0) æ¸…é™¤ AI è¼¸å…¥å€
        window.clearAiInput = () => {
            document.getElementById('aiInputText').value = '';
            document.getElementById('aiImportFile').value = ''; // æ¸…ç©º file input
            aiUploadedFiles = []; // æ¸…ç©ºå¿«å–çš„æª”æ¡ˆ
            document.getElementById('aiFileNameDisplay').textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
            document.getElementById('aiResultsContainer').innerHTML = '<div class="ai-no-result">å°šç„¡è¾¨è­˜çµæœ</div>';
            document.getElementById('importAllAiBtn').style.display = 'none';
        }

        // (v1.8.0) è™•ç† AI è¼¸å…¥ (æ–‡å­—æˆ–æª”æ¡ˆ) - (v1.7.0 çš„ processAiInput å‡ç´šç‰ˆ)
        window.processAiInput = async () => {
            // (v1.8.0) è¼‰å…¥ä¸¦æª¢æŸ¥ API Key
            userAiApiKey = document.getElementById('aiApiKeyInput').value.trim();
            if (!userAiApiKey) {
                 const savedKey = localStorage.getItem('calendarAiApiKey');
                 if (savedKey) {
                     userAiApiKey = savedKey;
                     document.getElementById('aiApiKeyInput').value = savedKey; // (v1.8.0) å¹«ä½¿ç”¨è€…å¡«å›
                 } else {
                     showCustomAlert('è«‹å…ˆåœ¨ AI è¾¨è­˜è¦–çª—é ‚éƒ¨è¼¸å…¥æ‚¨çš„ Google AI API é‡‘é‘°ï¼\n(é‡‘é‘°æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬æ©Ÿä¸­ï¼Œä¸æœƒå¤–æ´©)');
                     return;
                 }
            }

            const textInput = document.getElementById('aiInputText').value.trim();
            
            // æª¢æŸ¥æ˜¯ä½¿ç”¨æ–‡å­—è¼¸å…¥é‚„æ˜¯æª”æ¡ˆè¼¸å…¥
            if (!textInput && aiUploadedFiles.length === 0) {
                showCustomAlert('è«‹åœ¨å·¦æ–¹æ¬„ä½è²¼ä¸Šæ–‡å­—æˆ–ä¸Šå‚³æª”æ¡ˆ (.txt, .pdf, åœ–ç‰‡)ã€‚');
                return;
            }

            // é¡¯ç¤ºè™•ç†ä¸­æç¤º
            const resultsContainer = document.getElementById('aiResultsContainer');
            // (å¯è‡ªè¡Œä¿®æ”¹) AI è™•ç†ä¸­æç¤ºæ–‡å­—
            resultsContainer.innerHTML = '<div class="ai-no-result">ğŸ¤– AI æ­£åœ¨åŠªåŠ›è§£æä¸­ï¼Œè«‹ç¨å€™... (é€™å¯èƒ½éœ€è¦ 10-30 ç§’)</div>';
            document.getElementById('importAllAiBtn').style.display = 'none';

            let contentToParse = textInput;
            let imageParts = []; // (v1.8.0) å„²å­˜åœ–ç‰‡è³‡æ–™

            try {
                // å„ªå…ˆè™•ç†æª”æ¡ˆ
                if (aiUploadedFiles.length > 0) {
                    // (v1.8.0) è™•ç†æª”æ¡ˆ (åƒè€ƒ é›²æ•™å®¤é¡Œç›®ç”Ÿæˆå™¨ é‚è¼¯)
                    resultsContainer.innerHTML = '<div class="ai-no-result">âš™ï¸ æ­£åœ¨è™•ç†ä¸Šå‚³çš„æª”æ¡ˆ...</div>';
                    for (const file of aiUploadedFiles) {
                        if (file.type.startsWith('image/')) {
                            // è™•ç†åœ–ç‰‡
                            const base64Data = await readFileAsBase64(file);
                            imageParts.push({
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Data.split(',')[1] // ç§»é™¤ data:mime/type;base64,
                                }
                            });
                        } else if (file.type === 'text/plain') {
                            // è™•ç† TXT
                            contentToParse += await readFileAsText(file) + '\n';
                        } else if (file.type === 'application/pdf') {
                            // è™•ç† PDF
                            contentToParse += await readPdfFile(file) + '\n';
                        }
                    }
                    resultsContainer.innerHTML = '<div class="ai-no-result">ğŸ¤– AI æ­£åœ¨åŠªåŠ›è§£æä¸­ï¼Œè«‹ç¨å€™...</div>';
                }

                // *** (v1.8.0) å‘¼å«çœŸæ­£çš„ AI API ***
                const parsedEvents = await callGeminiApi(contentToParse, imageParts);
                
                // (v1.8.0) æ¸…ç©ºè¼¸å…¥å€
                clearAiInput();
                
                renderAiResults(parsedEvents); // (v1.8.0) ç¹¼çºŒä½¿ç”¨ v1.7.0 çš„æ¸²æŸ“å‡½å¼ (æˆ‘å€‘æŠŠå®ƒç§»åˆ°ä¸‹é¢äº†)

            } catch (error) {
                console.error("AI è¾¨è­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                resultsContainer.innerHTML = `<div class="ai-no-result" style="text-align: left; padding: 10px; background: #ffebee; border: 1px solid #e57373; border-radius: 5px; color: #c62828;">âŒ è¾¨è­˜å¤±æ•—ï¼š<br><br>${error.message}</div>`;
            }
        }
        
        // (v1.8.0) è¼”åŠ©å‡½å¼ï¼šè®€å–æª”æ¡ˆç‚º Base64 (ç”¨æ–¼åœ–ç‰‡)
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // (v1.8.0) è¼”åŠ©å‡½å¼ï¼šè®€å–æª”æ¡ˆç‚ºæ–‡å­— (ç”¨æ–¼ TXT)
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsText(file, 'UTF-8');
            });
        }

        // (v1.8.0) è¼”åŠ©å‡½å¼ï¼šè®€å– PDF æª”æ¡ˆ (åƒè€ƒ é›²æ•™å®¤é¡Œç›®ç”Ÿæˆå™¨)
        async function readPdfFile(file) {
            return new Promise(async (resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const loadingTask = pdfjsLib.getDocument(new Uint8Array(e.target.result));
                        const pdf = await loadingTask.promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        resolve(text);
                    } catch (error) {
                        console.error("PDF è®€å–éŒ¯èª¤:", error);
                        reject(new Error("ç„¡æ³•è®€å–æ­¤ PDF æª”æ¡ˆï¼Œæª”æ¡ˆå¯èƒ½å·²ææ¯€ã€‚"));
                    }
                };
                reader.onerror = () => reject(new Error("è®€å– PDF æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚"));
                reader.readAsArrayBuffer(file);
            });
        }

        // (v1.8.0) çœŸæ­£å‘¼å« Gemini API çš„å‡½å¼ (æ ¸å¿ƒ)
       // (v1.8.0) çœŸæ­£å‘¼å« Gemini API çš„å‡½å¼ (æ ¸å¿ƒ) - (v1.8.1 å‡ç´šæ¨¡å‹)
        // (v1.8.0) çœŸæ­£å‘¼å« Gemini API çš„å‡½å¼ (æ ¸å¿ƒ) - (v1.8.2 ç§»é™¤æ—¥æœŸéæ¿¾)
        async function callGeminiApi(text, imageParts) {
            if (!userAiApiKey) {
                throw new Error("API Key æœªè¨­å®šã€‚");
            }

            // (v1.8.1) ä¾ç…§æ‚¨çš„æŒ‡ç¤ºï¼Œé–å®šä½¿ç”¨ gemini-2.5-flash-preview-05-20 æ¨¡å‹
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${userAiApiKey}`;
            
            // (v1.8.2) (å¯è‡ªè¡Œä¿®æ”¹) AI ç³»çµ±æç¤º (Prompt) - ç§»é™¤äº†ã€Œæœªä¾†ã€å’Œã€Œä¸è¦æŠ“å–éå»ã€çš„é™åˆ¶
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ´»å‹•åŠ©ç†ï¼Œä½ çš„ä»»å‹™æ˜¯å¾ä½¿ç”¨è€…æä¾›çš„ä»»ä½•æ–‡å­—ã€åœ–ç‰‡æˆ– PDF å…§å®¹ä¸­ï¼Œæ‰¾å‡ºã€Œæ‰€æœ‰å¯è¾¨è­˜çš„ã€æ´»å‹•ã€è¡Œç¨‹æˆ–å¾…è¾¦äº‹é … (ç„¡è«–æ˜¯éå»ã€ç¾åœ¨æˆ–æœªä¾†çš„äº‹ä»¶)ã€‚

ä½ çš„ç›®æ¨™æ˜¯å°‡é€™äº›è³‡è¨Šè½‰æ›ç‚ºä¸€å€‹ JSON é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å€‹ã€Œç¨ç«‹çš„ã€æ´»å‹•ã€‚

ä½ ã€Œå¿…é ˆã€åš´æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼ã€‚å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•æ´»å‹•ï¼Œè«‹å›å‚³ä¸€å€‹ç©ºé™£åˆ— []ã€‚

JSON çµæ§‹ï¼š
[
  {
    "title": "æ´»å‹•æ¨™é¡Œ (ç°¡æ½”æ˜ç­)",
    "date": "YYYY-MM-DD (å¿…é ˆæ˜¯é€™å€‹æ ¼å¼ï¼)",
    "time": "HH:MM (24å°æ™‚åˆ¶) æˆ– 'å…¨å¤©' (å¦‚æœæ²’æœ‰å…·é«”æ™‚é–“)",
    "location": "åœ°é» (å¦‚æœæœ‰çš„è©±)",
    "description": "è©³ç´°å…§å®¹æˆ–å‚™è¨» (æ¢åˆ—å¼)",
    "emoji": "ä¸€å€‹æœ€èƒ½ä»£è¡¨æ­¤æ´»å‹•çš„ emoji (ä¾‹å¦‚ï¼šç ”ç¿’ç”¨ ğŸ“–, é‹å‹•ç”¨ ğŸ”¥, æ…¶ç¥ç”¨ ğŸ‰)"
  }
]

é‡è¦è¦å‰‡ï¼š
1.  **æ—¥æœŸæ¨æ–·**ï¼š
    * å…§å®¹ä¸­å¿…é ˆæœ‰æ˜ç¢ºçš„ã€Œæ—¥æœŸã€ï¼ˆä¾‹å¦‚ï¼š7/10, 2025å¹´7æœˆ10æ—¥ï¼‰ã€‚
    * å¦‚æœå…§å®¹ä¸­æ²’æœ‰ã€Œå¹´ä»½ã€ï¼Œè«‹æ ¹æ“šã€Œä»Šå¤©ã€çš„æ—¥æœŸ (å‡è¨­ä»Šå¤©æ˜¯ ${new Date().toISOString().split('T')[0]}) ä¾†æ¨æ–·ã€Œæœ€åˆç†çš„ã€å¹´ä»½ã€‚
    * ä¾‹å¦‚ï¼šå¦‚æœä»Šå¤©æ˜¯ 2025-10-25ï¼Œæåˆ° "7/10"ï¼Œè«‹ä½¿ç”¨ 2025-07-10ã€‚æåˆ° "11/5"ï¼Œè«‹ä½¿ç”¨ 2025-11-05ã€‚(å³ï¼Œå„ªå…ˆä½¿ç”¨ç•¶å‰å¹´ä»½)
    * (v1.8.2) ç§»é™¤ã€Œä¸è¦æŠ“å–éå»æ—¥æœŸã€çš„é™åˆ¶ã€‚
2.  **å…§å®¹éæ¿¾**ï¼šå¿½ç•¥ç„¡é—œçš„èŠå¤©ã€ç¯„ä¾‹æ–‡å­— (ä¾‹å¦‚ "ä¾‹å¦‚ï¼š7/10...") æˆ–éæ´»å‹•è³‡è¨Šã€‚
3.  **æ ¼å¼åŒ–**ï¼š
    * æ—¥æœŸã€Œå¿…é ˆã€æ˜¯ YYYY-MM-DD æ ¼å¼ã€‚
    * æ™‚é–“ã€Œå¿…é ˆã€æ˜¯ HH:MM æ ¼å¼æˆ– "å…¨å¤©"ã€‚
    * æè¿° (description) è«‹ä½¿ç”¨æ¢åˆ—å¼ (ç”¨ \n æ›è¡Œ) ç¸½çµé‡é»ã€‚
    * Emojiã€Œå¿…é ˆã€åªæä¾›ä¸€å€‹ç›¸é—œçš„è¡¨æƒ…ç¬¦è™Ÿã€‚
`;

            // (v1.8.1) çµ„åˆå‚³é€çš„ parts (é©ç”¨æ–¼æ‰€æœ‰å¤šæ¨¡æ…‹æ¨¡å‹)
            // æˆ‘å€‘å°‡æ–‡å­—å’Œåœ–ç‰‡ç©¿æ’åœ¨ä¸€èµ·
            const parts = [];
            if (text && text.trim()) {
                parts.push({ text: `æ–‡å­—èªªæ˜ï¼š\n${text}` });
            }
            
            // (v1.8.1) æª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡ï¼Œä¸¦åŠ å…¥
            if (imageParts && imageParts.length > 0) {
                parts.push(...imageParts); // åŠ å…¥æ‰€æœ‰åœ–ç‰‡
            }

            // (v1.8.1) å¦‚æœåªæœ‰åœ–ç‰‡æ²’æœ‰æ–‡å­—ï¼Œä¹Ÿéœ€è¦ä¸€å€‹æç¤º
            if (parts.length === 0) {
                 throw new Error("æ²’æœ‰æä¾›ä»»ä½•æ–‡å­—æˆ–åœ–ç‰‡å…§å®¹ã€‚");
            }
            
            // (v1.8.1) åŠ ä¸Šçµå°¾æç¤º
            parts.push({ text: "\n--- \nè«‹æ ¹æ“šä¸Šè¿°å…§å®¹ï¼Œä¾å¾ªæŒ‡ç¤ºé–‹å§‹åˆ†æã€‚" });
            
            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: 0.2
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API éŒ¯èª¤:", errorBody);
                let errorMsg = errorBody.error?.message || "AI API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ API Key æˆ–ç¶²è·¯é€£ç·šã€‚";
                if (errorMsg.includes("API key not valid")) {
                    errorMsg = "æ‚¨çš„ Google AI API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°å„²å­˜ã€‚";
                }
                // (v1.8.1) æª¢æŸ¥æ¨¡å‹æ¬Šé™éŒ¯èª¤
                if (errorMsg.includes("User location is not supported") || errorMsg.includes("model is not supported")) {
                    errorMsg = "API Key æ¬Šé™éŒ¯èª¤ï¼šæ‚¨çš„åœ°å€æˆ–é‡‘é‘°ç›®å‰ä¸æ”¯æ´æ­¤æ¨¡å‹ (gemini-2.5-flash-preview-05-20)ï¼Œè«‹å˜—è©¦æ›´æ›é‡‘é‘°ï¼Œæˆ–è¯ç¹«æˆ‘åˆ‡æ›å› gemini-1.5-flash-latestã€‚";
                }
                throw new Error(errorMsg);
            }

            const result = await response.json();
            
            if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                 throw new Error("AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºï¼ŒæœªåŒ…å«æœ‰æ•ˆçš„ JSON æ–‡å­—ã€‚");
            }

            const jsonText = result.candidates[0].content.parts[0].text;
            
            try {
                const cleanJsonText = jsonText.replace(/^```json\s*|```\s*$/g, '');
                const parsedData = JSON.parse(cleanJsonText);
                
                // (v1.1.0) å¯¦ä½œæ¨™é¡Œç°¡åŒ–é‚è¼¯ (ä¾æ“šæ–°è¦å‰‡ 2 & 5)
                return parsedData.map((item, index) => {
                    
                    // (v1.1.0) è¦å‰‡ 5ï¼šç°¡åŒ–æ¨™é¡Œ (0-10å­—)
                    let simpleTitle = item.title;
                    if (simpleTitle.length > 10) {
                        simpleTitle = simpleTitle.substring(0, 10) + 'â€¦';
                    }

                    // (v1.1.0) è¦å‰‡ 2ï¼šçµ„åˆé¡¯ç¤ºæ¨™é¡Œ
                    // åªæœ‰åœ¨ time å­˜åœ¨ä¸”ä¸æ˜¯ 'å…¨å¤©' æ™‚ï¼Œæ‰åŠ ä¸Š [HH:MM]
                    let displayTitle = simpleTitle;
                    if (item.time && item.time !== 'å…¨å¤©') {
                        // ç¢ºä¿æ™‚é–“æ ¼å¼æ˜¯ HH:MM (ä¾‹å¦‚ AI å¯èƒ½åªçµ¦ 19:00)
                        const timeParts = item.time.split(':');
                        const hours = timeParts[0] ? timeParts[0].padStart(2, '0') : '00';
                        const minutes = timeParts[1] ? timeParts[1].padEnd(2, '0') : '00';
                        displayTitle = `[${hours}:${minutes}] ${simpleTitle}`;
                    }
                    
                    // (v1.1.0) æª¢æŸ¥æ˜¯å¦æœ‰é€£çºŒæ—¥æœŸ (è¦å‰‡ 4)
                    // ç›®å‰çš„ AI Prompt (v1.8.2) åªæœ‰è¦æ±‚ "date": "YYYY-MM-DD"
                    // æˆ‘å€‘å…ˆå‡è¨­ AI è¾¨è­˜çš„éƒ½æ˜¯å–®æ—¥äº‹ä»¶ï¼Œä½¿ç”¨è€…å¯åœ¨ä»‹é¢ä¸Šæ‰‹å‹•ä¿®æ”¹ç¯„åœ
                    
                    const eventDate = item.date || new Date().toISOString().split('T')[0]; // é é˜² AI æ¼çµ¦æ—¥æœŸ

                    return {
                        id: `ai_${Date.now()}_${index}`, // å”¯ä¸€çš„å¡ç‰‡ ID
                        
                        // (v1.1.0) ä¿ç•™ AI åŸå§‹è³‡æ–™ï¼Œç”¨æ–¼ä»‹é¢ç·¨è¼¯
                        originalTitle: item.title, // AI åŸå§‹å®Œæ•´æ¨™é¡Œ
                        originalDate: eventDate,
                        originalTime: item.time || 'å…¨å¤©',
                        originalLocation: item.location || '',
                        originalDescription: item.description || '',
                        
                        // (v1.1.0) é¡¯ç¤ºèˆ‡ç·¨è¼¯ç”¨çš„è³‡æ–™
                        displayTitle: displayTitle,    // ç”¨æ–¼å¡ç‰‡æ¨™é¡Œ (æœƒå‹•æ…‹æ›´æ–°)
                        simplifiedTitle: simpleTitle,  // ç°¡åŒ–æ¨™é¡Œ (ç”¨æ–¼ç·¨è¼¯å™¨é è¨­å€¼)
                        
                        // (v1.1.0) è¦å‰‡ 5ï¼šä½¿ç”¨ AI çš„ emojiï¼Œé è¨­ç‚º ğŸ’¡
                        emoji: item.emoji || 'ğŸ’¡', 
                        
                        // (v1.1.0) è¦å‰‡ 4ï¼šé è¨­é–‹å§‹/çµæŸæ—¥æœŸç‚ºåŒä¸€å¤©
                        startDate: eventDate, 
                        endDate: eventDate,
                        
                        color: '' // é è¨­ç„¡é¡è‰²
                    };
                });

            } catch (e) {
                console.error("è§£æ AI å›å‚³çš„ JSON å¤±æ•—:", e);
                console.error("åŸå§‹ JSON æ–‡å­—:", jsonText);
                throw new Error("AI å›å‚³äº†ç„¡æ•ˆçš„ JSON æ ¼å¼ï¼Œç„¡æ³•è§£æã€‚");
            }
        }
        
        // (v1.8.0) è¼”åŠ©å‡½å¼ï¼šè¨­å®šæª”æ¡ˆæ‹–æ›³äº‹ä»¶ (ç”¨æ–¼ AI Modal)
        function setupAiDragDrop() {
            const dropZone = document.getElementById('aiFileDropZone');
            if (!dropZone) return; // (v1.8.0) é˜²å‘†
            
            // (v1.8.0) é˜²æ­¢é‡è¤‡ç¶å®š
            if (dropZone.dataset.eventsBound) return; 
            dropZone.dataset.eventsBound = 'true';

            const fileInput = document.getElementById('aiImportFile');
            const fileNameDisplay = document.getElementById('aiFileNameDisplay');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            const handleFiles = (files) => {
                aiUploadedFiles = Array.from(files); // (v1.8.0) å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
                if (aiUploadedFiles.length > 0) {
                    // (å¯è‡ªè¡Œä¿®æ”¹) é¸ä¸­æª”æ¡ˆå¾Œçš„æç¤ºæ–‡å­—
                    fileNameDisplay.textContent = `å·²é¸æ“‡ ${aiUploadedFiles.length} å€‹æª”æ¡ˆï¼š${aiUploadedFiles.map(f => f.name).join(', ')}`;
                } else {
                    fileNameDisplay.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
                }
            };

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                fileInput.files = files; // (v1.8.0) ç¢ºä¿ file input ä¹ŸåŒæ­¥
                handleFiles(files);
            }, false);

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // (v1.1.0) æ¸²æŸ“ AI è¾¨è­˜çµæœåˆ°ç•«é¢ä¸Š (å…¨æ–°ä»‹é¢)
        function renderAiResults(parsedEvents) {
            const resultsContainer = document.getElementById('aiResultsContainer');
            const importAllBtn = document.getElementById('importAllAiBtn');
            resultsContainer.innerHTML = '';

            if (parsedEvents.length === 0) {
                // (å¯è‡ªè¡Œä¿®æ”¹) AI æ‰¾ä¸åˆ°å…§å®¹çš„æç¤ºæ–‡å­—
                // (v1.8.2) ç§»é™¤äº†ã€Œæœªä¾†ã€çš„é™åˆ¶ï¼Œä¿®æ­£æç¤ºæ–‡å­—
                resultsContainer.innerHTML = '<div class="ai-no-result">å–”å–”ï¼åœ¨æ‚¨æä¾›çš„å…§å®¹ä¸­æ‰¾ä¸åˆ°å¯è¾¨è­˜çš„æ´»å‹•è³‡è¨Šã€‚</div>';
                importAllBtn.style.display = 'none';
                return;
            }

            importAllBtn.style.display = 'inline-block';
            
            // (v1.1.0) æ³¨æ„ï¼šç”±æ–¼ä»‹é¢è¤‡é›œåŒ–ï¼Œ"å…¨éƒ¨åŒ¯å…¥"æŒ‰éˆ•ç¾åœ¨åªæ˜¯ä¸€å€‹è§¸ç™¼å™¨
            // å®ƒæœƒè§¸ç™¼ä¸‹é¢æ‰€æœ‰å¡ç‰‡çš„ "åŒ¯å…¥æ­¤é …" æŒ‰éˆ•
            // æˆ‘å€‘ä¸å†å°‡è³‡æ–™å­˜åœ¨æŒ‰éˆ•ä¸Š
            // importAllBtn.dataset.events = JSON.stringify(parsedEvents);

            parsedEvents.forEach(event => {
                const card = document.createElement('div');
                card.className = 'ai-result-card form-like'; // (v1.1.0) ä½¿ç”¨æ–°æ¨£å¼
                card.id = event.id; // é€™å€‹ ID æ˜¯ `ai_xxxx`

                // (v1.1.0) è¦å‰‡ 3 & 4ï¼šçµ„åˆäº‹ä»¶å…§å®¹ (Content)
                // é€™æ˜¯æº–å‚™æ”¾å…¥ *å¯ç·¨è¼¯* <textarea> çš„ *é è¨­å€¼*
                let detailsText = '';
                detailsText += `ğŸ“‹ åŸå§‹æ¨™é¡Œ: ${event.originalTitle}\n\n`; 
                if(event.originalTime && event.originalTime !== 'å…¨å¤©') detailsText += `â° æ™‚é–“: ${event.originalTime}\n\n`;
                if(event.originalLocation) detailsText += `ğŸ“ åœ°é»: ${event.originalLocation}\n\n`;
                if(event.originalDescription.trim()) detailsText += `ğŸ’¬ AI å‚™è¨»:\n${event.originalDescription.trim()}\n\n`;
                
                // (v1.1.0) è¤‡è£½é¡è‰²å’Œè¡¨æƒ…ç¬¦è™Ÿé¸æ“‡å™¨çš„ HTML
                // æˆ‘å€‘å¾ä¸»é é¢çš„ modal è¤‡è£½çµæ§‹
                // (è¦ç¢ºä¿ #eventModal å­˜åœ¨)
                const colorPickerHtml = document.querySelector('#eventModal .color-picker') ? document.querySelector('#eventModal .color-picker').innerHTML : '';
                const emojiPickerHtml = document.querySelector('#eventModal .emoji-picker') ? document.querySelector('#eventModal .emoji-picker').innerHTML : '';

                // (v1.1.0) è¦å‰‡ 1 & 3ï¼šæ¸²æŸ“å®Œæ•´çš„è¡¨å–®ä»‹é¢
                card.innerHTML = `
                    <div class="ai-result-header">
                        <h5 id="displayTitle_${event.id}">ğŸ·ï¸ ${event.displayTitle}</h5>
                        <button class="btn btn-primary btn-ai-import" style="padding: 5px 10px; font-size: 0.8rem;">åŒ¯å…¥æ­¤é …</button>
                    </div>
                    <div class="ai-result-details" style="display: block;"> <div class="form-group">
                            <label for="aiTitle_${event.id}">ğŸ“‹ äº‹ä»¶æ¨™é¡Œ (æœƒå½±éŸ¿ä¸Šæ–¹æ¨™é¡Œ)ï¼š</label>
                            <input type="text" id="aiTitle_${event.id}" value="${event.simplifiedTitle}">
                        </div>
                        
                        <div class="form-group">
                            <label for="aiContent_${event.id}">ğŸ“„ äº‹ä»¶å…§å®¹ï¼š</label>
                            <textarea id="aiContent_${event.id}" class="ai-result-textarea">${detailsText.trim()}</textarea>
                        </div>
                        
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label for="aiStartDate_${event.id}">ğŸ—“ï¸ é–‹å§‹æ—¥æœŸï¼š</label>
                                <input type="date" id="aiStartDate_${event.id}" value="${event.startDate}">
                            </div>
                            <div style="flex: 1;">
                                <label for="aiEndDate_${event.id}">ğŸ—“ï¸ çµæŸæ—¥æœŸï¼š</label>
                                <input type="date" id="aiEndDate_${event.id}" value="${event.endDate}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ğŸ¨ é¡è‰²æ¨™ç±¤ï¼š</label>
                            <div class="color-picker" data-card-id="${event.id}">
                                ${colorPickerHtml}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ğŸ˜Š è¡¨æƒ…ç¬¦è™Ÿï¼š</label>
                            <div class="emoji-picker" data-card-id="${event.id}">
                                ${emojiPickerHtml}
                            </div>
                        </div>
                        <input type="hidden" id="aiTime_${event.id}" value="${event.originalTime}">
                    </div>
                `;
                
                resultsContainer.appendChild(card);

                // --- (v1.1.0) ç¶å®šæ–°ä»‹é¢çš„äº‹ä»¶ ---

                // é€™è£¡æˆ‘å€‘ç”¨ card (å‰›å»ºç«‹çš„å…ƒç´ ) ä¾†æ‰¾å°‹å­å…ƒç´ ï¼Œæ•ˆèƒ½æ›´å¥½
                
                // (v1.1.0) è¦å‰‡ 3ï¼šå³æ™‚æ›´æ–°æ¨™é¡Œ
                const titleInput = card.querySelector(`#aiTitle_${event.id}`);
                const displayTitleElement = card.querySelector(`#displayTitle_${event.id}`);
                const timeInput = card.querySelector(`#aiTime_${event.id}`); // æŠ“éš±è—çš„æ™‚é–“

                titleInput.addEventListener('input', () => {
                    let newTitle = titleInput.value.trim();
                    if (newTitle.length > 10) {
                        newTitle = newTitle.substring(0, 10) + 'â€¦';
                    }
                    
                    const time = timeInput.value;
                    if (time && time !== 'å…¨å¤©') {
                        // (v1.1.0) ç¢ºä¿æ™‚é–“æ ¼å¼æ­£ç¢º
                        const timeParts = time.split(':');
                        const hours = timeParts[0] ? timeParts[0].padStart(2, '0') : '00';
                        const minutes = timeParts[1] ? timeParts[1].padEnd(2, '0') : '00';
                        displayTitleElement.textContent = `ğŸ·ï¸ [${hours}:${minutes}] ${newTitle}`;
                    } else {
                        displayTitleElement.textContent = `ğŸ·ï¸ ${newTitle}`;
                    }
                });

                // (v1.1.0) ç¶å®šé¡è‰²é¸æ“‡
                const colorPicker = card.querySelector('.color-picker');
                colorPicker.addEventListener('click', (e) => {
                    const target = e.target.closest('.color-option');
                    if (!target) return;
                    
                    // ç§»é™¤åŒä¸€å€‹ card å…§çš„å…¶ä»–é¸ä¸­
                    colorPicker.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    // é¸ä¸­é»æ“Šçš„
                    target.classList.add('selected');
                });
                // é é¸ "ç„¡" (å¦‚æœ 'ç„¡' é¸é …å­˜åœ¨)
                const noneColorOption = colorPicker.querySelector('.color-option[data-color=""]');
                if (noneColorOption) {
                    noneColorOption.classList.add('selected');
                }


                // (v1.1.0) ç¶å®š Emoji é¸æ“‡
                const emojiPicker = card.querySelector('.emoji-picker');
                emojiPicker.addEventListener('click', (e) => {
                    const target = e.target.closest('.emoji-option');
                    if (!target) return;
                    
                    emojiPicker.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                    target.classList.add('selected');
                });
                // (v1.1.0) è¦å‰‡ 5ï¼šè‡ªå‹•é é¸ AI å»ºè­°çš„ Emoji
                const aiEmojiOption = emojiPicker.querySelector(`[data-emoji="${event.emoji}"]`);
                if (aiEmojiOption) {
                    aiEmojiOption.classList.add('selected');
                } else {
                    // å¦‚æœ AI çµ¦çš„ emoji ä¸åœ¨é¸é …ä¸­ï¼Œå°±é é¸ "ç„¡"
                    const noneEmojiOption = emojiPicker.querySelector('[data-emoji=""]');
                    if (noneEmojiOption) {
                        noneEmojiOption.classList.add('selected');
                    }
                }


                // (v1.1.0) ç¶å®š "åŒ¯å…¥æ­¤é …" æŒ‰éˆ•
                card.querySelector('.btn-ai-import').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    // (v1.1.0) å‚³éæ•´å€‹å¡ç‰‡å…ƒç´ ï¼Œä»¥ä¾¿è®€å–è³‡æ–™
                    importEventFromAI(card); 
                });

                resultsContainer.appendChild(card);
            });
        }
        
        // (v1.1.0) å¾ AI çµæœåŒ¯å…¥å–®ä¸€äº‹ä»¶ (å¾æ–°è¡¨å–®è®€å–)
        async function importEventFromAI(cardElement) {
            
            const cardId = cardElement.id; // é€™å€‹ ID æ˜¯ ai_xxxx

            try {
                // (v1.1.0) è¦å‰‡ 1, 3, 4ï¼šå¾è¡¨å–®ä»‹é¢è®€å–æ‰€æœ‰ä½¿ç”¨è€…ä¿®æ”¹éçš„è³‡æ–™
                const title = cardElement.querySelector(`#aiTitle_${cardId}`).value.trim();
                const content = cardElement.querySelector(`#aiContent_${cardId}`).value.trim();
                const startDate = cardElement.querySelector(`#aiStartDate_${cardId}`).value;
                const endDate = cardElement.querySelector(`#aiEndDate_${cardId}`).value;
                
                // (v1.1.0) è®€å–é¸æ“‡çš„é¡è‰²
                const selectedColorOption = cardElement.querySelector('.color-picker .selected');
                const color = selectedColorOption ? selectedColorOption.dataset.color : '';

                // (v1.1.0) è®€å–é¸æ“‡çš„ emoji
                const selectedEmojiOption = cardElement.querySelector('.emoji-picker .selected');
                const emoji = selectedEmojiOption ? selectedEmojiOption.dataset.emoji : 'ğŸ’¡';
                
                // (v1.1.0) åŸºæœ¬é©—è­‰
                if (!title) {
                    showCustomAlert('äº‹ä»¶æ¨™é¡Œä¸å¯ç‚ºç©ºï¼');
                    // è®“å¡ç‰‡éœ‡å‹•ä¸€ä¸‹æç¤ºéŒ¯èª¤
                    cardElement.style.animation = 'shake 0.5s';
                    setTimeout(() => cardElement.style.animation = '', 500);
                    return;
                }
                if (!startDate || !endDate) {
                    showCustomAlert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸï¼');
                    cardElement.style.animation = 'shake 0.5s';
                    setTimeout(() => cardElement.style.animation = '', 500);
                    return;
                }
                 // æ ¡æ­£æ™‚å€å•é¡Œå†æ¯”è¼ƒ
                 const compareStartDate = new Date(startDate);
                 const compareEndDate = new Date(endDate);
                 compareStartDate.setMinutes(compareStartDate.getMinutes() + compareStartDate.getTimezoneOffset());
                 compareEndDate.setMinutes(compareEndDate.getMinutes() + compareEndDate.getTimezoneOffset());

                if (compareStartDate > compareEndDate) {
                     showCustomAlert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼');
                    cardElement.style.animation = 'shake 0.5s';
                    setTimeout(() => cardElement.style.animation = '', 500);
                    return;
                }

                // (v1.1.0) è¦å‰‡ 1ï¼šçµ„åˆè¦å­˜åˆ° Firebase çš„è³‡æ–™
                const newEventData = {
                    title: title,
                    content: content, 
                    startDate: startDate, // (v1.1.0) è¦å‰‡ 4ï¼šä½¿ç”¨ä¿®æ”¹å¾Œçš„æ—¥æœŸ
                    endDate: endDate,   // (v1.1.0) è¦å‰‡ 4ï¼šä½¿ç”¨ä¿®æ”¹å¾Œçš„æ—¥æœŸ
                    color: color,
                    emoji: emoji, 
                    groupId: generateGroupId() // ç”¢ç”Ÿæ–°çš„ groupId
                };

                // (v1.1.0) è¦å‰‡ 4ï¼šå„²å­˜å¤šæ—¥äº‹ä»¶
                // æˆ‘å€‘ä½¿ç”¨èˆ‡ saveEvent é¡ä¼¼çš„é‚è¼¯
                
                const batch = writeBatch(db);
                const eventsCollectionRef = collection(db, 'public_events');

                // (v1.5.0) ä½¿ç”¨ dateRange è¼”åŠ©å‡½å¼
                for (const date of dateRange(startDate, endDate)) { 
                    const dateStr = formatDateYYYYMMDD(date);
                    const newDocRef = doc(eventsCollectionRef); // ç‚ºæ¯å€‹æ—¥æœŸå‰µå»ºæ–°æ–‡ä»¶
                    batch.set(newDocRef, {
                        ...newEventData,
                        date: dateStr // ç‰¹å®šæ—¥æœŸçš„äº‹ä»¶
                    });
                }

                // åŸ·è¡Œæ‰¹æ¬¡æ“ä½œ
                await batch.commit();
                
                // (v1.1.0) å¾ç•«é¢ä¸Šç§»é™¤å·²åŒ¯å…¥çš„é …ç›® (elementToRemove å°±æ˜¯ cardElement)
                cardElement.style.transition = 'opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease, padding 0.5s ease, margin 0.5s ease';
                cardElement.style.opacity = '0';
                cardElement.style.transform = 'scale(0.95)';
                cardElement.style.maxHeight = '0px';
                cardElement.style.padding = '0';
                cardElement.style.margin = '0';
                cardElement.style.overflow = 'hidden';

                setTimeout(() => {
                    cardElement.remove();
                    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é …ç›®éƒ½å·²åŒ¯å…¥
                    const container = document.getElementById('aiResultsContainer');
                    if (container.children.length === 0 || container.querySelectorAll('.ai-result-card').length === 0) {
                         container.innerHTML = '<div class="ai-no-result">æ‰€æœ‰äº‹ä»¶å‡å·²æˆåŠŸåŒ¯å…¥ï¼</div>';
                         document.getElementById('importAllAiBtn').style.display = 'none';
                    }
                }, 500);

            } catch (error) {
                console.error("å¾ AI åŒ¯å…¥äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showCustomAlert("åŒ¯å…¥äº‹ä»¶å¤±æ•—: " + error.message);
            }
        }
        
      // (v1.1.0) åŒ¯å…¥æ‰€æœ‰ AI è¾¨è­˜çš„äº‹ä»¶ (ä¿®æ”¹è§¸ç™¼é‚è¼¯)
        window.importAllAiEvents = () => {
             showCustomConfirm('ç¢ºå®šè¦å°‡ç›®å‰è¾¨è­˜å‡ºçš„æ‰€æœ‰äº‹ä»¶å…¨éƒ¨åŒ¯å…¥è¡Œäº‹æ›†å—ï¼Ÿ\n(å°‡ä¾æ“šæ‚¨åœ¨å¡ç‰‡ä¸Šä¿®æ”¹çš„å…§å®¹åŒ¯å…¥)', (choice) => {
                if (choice === 'confirm') {
                    // (v1.1.0) è¦å‰‡ 1ï¼šé¸å–æ‰€æœ‰ "åŒ¯å…¥æ­¤é …" æŒ‰éˆ•ä¸¦é»æ“Š
                    const allImportButtons = document.querySelectorAll('.ai-result-card .btn-ai-import');
                    if (allImportButtons.length === 0) {
                        showCustomAlert('æ²’æœ‰å¯åŒ¯å…¥çš„äº‹ä»¶ã€‚');
                        return;
                    }
                    // ç‚ºäº†é¿å…åŒæ™‚è§¸ç™¼å¤ªå¤š Firebase å¯«å…¥ï¼Œæˆ‘å€‘å¯ä»¥è€ƒæ…®ä¸€å€‹å€‹ä¾†
                    // ä½†ç›®å‰é»æ“Šæ‡‰è©²æ˜¯ç•°æ­¥çš„ï¼Œç›´æ¥å…¨éƒ¨è§¸ç™¼
                    allImportButtons.forEach(btn => {
                        btn.click(); // è§¸ç™¼æˆ‘å€‘åœ¨æ­¥é©Ÿä¸‰ç¶å®šçš„ importEventFromAI
                    });
                }
            });
        }
        // é¡¯ç¤ºè‡ªè¨‚æç¤ºæ¡†
        function showCustomAlert(message) {
            const alertModal = document.getElementById('alertModal');
            document.getElementById('alertMessage').textContent = message;
            alertModal.style.display = 'block';
        }

         // (v1.5.0) é¡¯ç¤ºè‡ªè¨‚ç¢ºèªæ¡†
        function showCustomConfirm(message, callback, title = "ğŸ’¡ è«‹ç¢ºèª", confirmText = "ç¢ºå®š", cancelText = "å–æ¶ˆ") {
            const confirmModal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            const confirmBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

             // ç§»é™¤èˆŠçš„ç›£è½å™¨ä»¥é¿å…é‡è¤‡è§¸ç™¼
             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
             const newCancelBtn = cancelBtn.cloneNode(true);
             cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);


             newConfirmBtn.onclick = () => {
                 confirmModal.style.display = 'none';
                 if (callback) callback('confirm'); // å‚³éç¢ºèªä¿¡è™Ÿ
             };

             newCancelBtn.onclick = () => {
                 confirmModal.style.display = 'none';
                 if (callback) callback('cancel'); // å‚³éå–æ¶ˆä¿¡è™Ÿ
             };


            confirmModal.style.display = 'block';
        }


    </script>
    <style>
        :root {
            /* åŸºæœ¬é¡è‰² */
            --color-white: #ffffff;
            --color-black: #333333;
            --color-grey-light: #f0f0f0;
            --color-grey-mid: #dddddd;
            --color-grey-dark: #666666;

            /* ä¸»è¦æŒ‰éˆ•é¡è‰² */
            --color-primary: #2196f3;
            --color-danger: #f44336;
            --color-secondary: #666666;

            /* äº‹ä»¶é¡è‰² */
            --event-red: #ffcdd2;
            --event-blue: #bbdefb;
            --event-green: #c8e6c9;
            --event-yellow: #fff9c4;
            --event-purple: #e1bee7;
            --event-orange: #ffccbc;
            --event-pink: #f8bbd9;
            --event-cyan: #b2ebf2;

             /* (v1.5.0 -> v1.6.0) æœå°‹é¢æ¿å¯¬åº¦èª¿æ•´ */
             --search-panel-width: 280px;
        }

        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden; /* éš±è—æ»¾å‹•æ¢ï¼Œå› ç‚ºæˆ‘å€‘åœ¨ container ç¸®æ”¾ */
            transition: padding-left 0.3s ease; /* (v1.6.0) åŠ å…¥éæ¸¡æ•ˆæœ */
            display: flex;
            justify-content: center; /* æ°´å¹³ç½®ä¸­ */
            align-items: flex-start; /* é ä¸Šå°é½Š */
             /* (v1.6.0) é è¨­ç„¡ paddingï¼Œç”± JS æ§åˆ¶ */
             padding-left: 0;
        }
        /* (v1.6.0) ç•¶æœå°‹é¢æ¿é¡¯ç¤ºæ™‚ï¼ŒåŠ å…¥ padding */
        body.search-panel-visible {
             padding-left: var(--search-panel-width);
        }


        /* --- ä¸»é¡Œæ¨£å¼ --- */
        /* ç§‘æŠ€é¢¨ (é è¨­) */
        .theme-tech {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: var(--color-white);
            --theme-bg: linear-gradient(135deg, #1a1a2e, #16213e);
            --theme-text: var(--color-white);
            --theme-bg-trans-1: rgba(255, 255, 255, 0.1);
            --theme-bg-trans-2: rgba(255, 255, 255, 0.2);
            --theme-bg-trans-3: rgba(255, 255, 255, 0.3);
            --theme-border: rgba(255, 255, 255, 0.15);
            --theme-modal-bg: rgba(30, 40, 70, 0.95);
            --theme-modal-text: var(--color-white);
            --theme-input-bg: rgba(255, 255, 255, 0.1);
            --theme-input-text: var(--color-white);
            --theme-input-placeholder: rgba(255, 255, 255, 0.7);
            --theme-select-bg: #16213e; /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®èƒŒæ™¯ */
            --theme-select-text: var(--color-white); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®æ–‡å­— */
            --theme-sticky-bg: #2a2a4e;
            --theme-sticky-text: var(--color-white);
            --theme-event-text: var(--color-white); /* (ä¿®æ­£) äº‹ä»¶æ–‡å­—é¡è‰² */
            --theme-color-scheme: dark; /* (v1.3.0) æ—¥æœŸè¼¸å…¥æ¡†é…è‰² */
             --search-panel-bg: rgba(22, 33, 62, 0.9); /* (v1.5.0) ç§‘æŠ€é¢¨æœå°‹é¢æ¿èƒŒæ™¯ */
             --sticky-footer-text: rgba(255, 255, 255, 0.7); /* (v1.6.0) */
        }

        /* æµ·æ´‹é¢¨ */
        .theme-ocean {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #0d47a1;
            --theme-bg: linear-gradient(135deg, #e3f2fd, #bbdefb);
            --theme-text: #0d47a1;
            --theme-bg-trans-1: rgba(255, 255, 255, 0.3);
            --theme-bg-trans-2: rgba(255, 255, 255, 0.5);
            --theme-bg-trans-3: rgba(255, 255, 255, 0.7);
            --theme-border: rgba(0, 0, 0, 0.1);
            --theme-modal-bg: rgba(255, 255, 255, 0.98);
            --theme-modal-text: var(--color-black);
            --theme-input-bg: rgba(255, 255, 255, 0.7);
            --theme-input-text: var(--color-black);
            --theme-input-placeholder: rgba(0, 0, 0, 0.5);
            --theme-select-bg: var(--color-white); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®èƒŒæ™¯ */
            --theme-select-text: var(--color-black); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®æ–‡å­— */
            --theme-sticky-bg: #fff9c4;
            --theme-sticky-text: var(--color-black);
            --theme-event-text: var(--color-black); /* (ä¿®æ­£) äº‹ä»¶æ–‡å­—é¡è‰² */
            --theme-color-scheme: light; /* (v1.3.0) æ—¥æœŸè¼¸å…¥æ¡†é…è‰² */
             --search-panel-bg: rgba(227, 242, 253, 0.9); /* (v1.5.0) æµ·æ´‹é¢¨æœå°‹é¢æ¿èƒŒæ™¯ */
             --sticky-footer-text: rgba(0, 0, 0, 0.6); /* (v1.6.0) */
        }

        /* æ˜¥å¤©é¢¨ */
        .theme-spring {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            color: #880e4f;
            --theme-bg: linear-gradient(135deg, #fce4ec, #f8bbd9);
            --theme-text: #880e4f;
            --theme-bg-trans-1: rgba(255, 255, 255, 0.3);
            --theme-bg-trans-2: rgba(255, 255, 255, 0.5);
            --theme-bg-trans-3: rgba(255, 255, 255, 0.7);
            --theme-border: rgba(136, 14, 79, 0.15);
            --theme-modal-bg: rgba(255, 255, 255, 0.98);
            --theme-modal-text: var(--color-black);
            --theme-input-bg: rgba(255, 255, 255, 0.7);
            --theme-input-text: var(--color-black);
            --theme-input-placeholder: rgba(0, 0, 0, 0.5);
            --theme-select-bg: var(--color-white); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®èƒŒæ™¯ */
            --theme-select-text: var(--color-black); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®æ–‡å­— */
            --theme-sticky-bg: #fff9c4;
            --theme-sticky-text: var(--color-black);
            --theme-event-text: var(--color-black); /* (ä¿®æ­£) äº‹ä»¶æ–‡å­—é¡è‰² */
            --theme-color-scheme: light; /* (v1.3.0) æ—¥æœŸè¼¸å…¥æ¡†é…è‰² */
             --search-panel-bg: rgba(252, 228, 236, 0.9); /* (v1.5.0) æ˜¥å¤©é¢¨æœå°‹é¢æ¿èƒŒæ™¯ */
             --sticky-footer-text: rgba(0, 0, 0, 0.6); /* (v1.6.0) */
        }

        /* è‰åŸé¢¨ */
        .theme-meadow {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #1b5e20;
            --theme-bg: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            --theme-text: #1b5e20;
            --theme-bg-trans-1: rgba(255, 255, 255, 0.3);
            --theme-bg-trans-2: rgba(255, 255, 255, 0.5);
            --theme-bg-trans-3: rgba(255, 255, 255, 0.7);
            --theme-border: rgba(27, 94, 32, 0.15);
            --theme-modal-bg: rgba(255, 255, 255, 0.98);
            --theme-modal-text: var(--color-black);
            --theme-input-bg: rgba(255, 255, 255, 0.7);
            --theme-input-text: var(--color-black);
            --theme-input-placeholder: rgba(0, 0, 0, 0.5);
            --theme-select-bg: var(--color-white); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®èƒŒæ™¯ */
            --theme-select-text: var(--color-black); /* (ä¿®æ­£) ä¸‹æ‹‰é¸å–®æ–‡å­— */
            --theme-sticky-bg: #fff9c4;
            --theme-sticky-text: var(--color-black);
            --theme-event-text: var(--color-black); /* (ä¿®æ­£) äº‹ä»¶æ–‡å­—é¡è‰² */
            --theme-color-scheme: light; /* (v1.3.0) æ—¥æœŸè¼¸å…¥æ¡†é…è‰² */
             --search-panel-bg: rgba(232, 245, 233, 0.9); /* (v1.5.0) è‰åŸé¢¨æœå°‹é¢æ¿èƒŒæ™¯ */
             --sticky-footer-text: rgba(0, 0, 0, 0.6); /* (v1.6.0) */
        }

        /* --- åŸºç¤çµæ§‹ --- */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            display: flex;
            flex-direction: column;

            /* (å¯è‡ªè¡Œä¿®æ”¹) ç¸®æ”¾ 90% ä¸¦èª¿æ•´é«˜åº¦ */
            height: calc(100vh / 0.9); /* è¨ˆç®—ç¸®æ”¾å¾Œçš„é«˜åº¦ä»¥å¡«æ»¿è¦–çª— */
            transform-origin: top center; /* å¾é ‚éƒ¨ä¸­å¿ƒé–‹å§‹ç¸®æ”¾ */
            transform: scale(0.9);

            flex-grow: 1;
            min-height: 0;
            position: relative; /* (v1.5.0) ç‚ºäº†è®“æœå°‹é¢æ¿ä¸å½±éŸ¿ä½ˆå±€ */
            z-index: 1; /* (v1.5.0) ç¢ºä¿åœ¨æœå°‹é¢æ¿ä¸‹æ–¹ */
             transition: transform 0.3s ease; /* (v1.6.0) åŠ å…¥éæ¸¡ */
        }
         /* (v1.6.0) æœå°‹é¢æ¿é¡¯ç¤ºæ™‚ï¼Œä¸»å®¹å™¨ç¨å¾®å³ç§»ä¸€é»é»ï¼Œé¿å…å®Œå…¨é‡ç–Š */
         body.search-panel-visible .container {
              transform: scale(0.9) translateX(10px);
         }


        /* --- æ¨™é¡Œå€åŸŸ (ç‰ˆé¢é‡æ§‹) --- */
        .header {
            display: grid;
            /* (å¯è‡ªè¡Œä¿®æ”¹) ç‰ˆé¢é…ç½® */
            grid-template-columns: 1fr auto 1fr; /* å·¦ä¸­å³ä¸‰æ¬„ */
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-shrink: 0;
        }

        /* å·¦å´ï¼šæ¨™é¡Œ + ä»Šå¤© */
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-self: start; /* é å·¦ */
        }

        .calendar-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--theme-text);
            cursor: pointer; /* (æ–°å¢) æç¤ºå¯é»æ“Š */
            transition: opacity 0.3s ease;
        }
        .calendar-title:hover {
            opacity: 0.8;
        }

        /* ä¸­é–“ï¼šå°èˆª */
        .header-center {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-self: center; /* ç½®ä¸­ */
        }

        /* å³å´ï¼šæœå°‹ + è¨­å®š */
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-self: end; /* é å³ */
        }

        .nav-btn {
            background: var(--theme-bg-trans-2);
            border: 1px solid var(--theme-border);
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: var(--theme-text);
        }

        .nav-btn:hover {
            background: var(--theme-bg-trans-3);
            transform: translateY(-2px);
        }

        .month-year {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-select, .year-select {
            background: var(--theme-input-bg);
            border: 1px solid var(--theme-border);
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--theme-input-text);
            min-width: 100px;
        }

        /* (ä¿®æ­£) è™•ç†ä¸‹æ‹‰é¸å–®åœ¨ä¸åŒä¸»é¡Œçš„æ¨£å¼ */
        .month-select, .year-select {
            background-color: var(--theme-select-bg);
            color: var(--theme-select-text);
        }
        .month-select option, .year-select option {
            background-color: var(--theme-select-bg);
            color: var(--theme-select-text);
        }


        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            width: 100%;
            min-width: 250px; /* (å¯è‡ªè¡Œä¿®æ”¹) æœå°‹æ¡†æœ€å°å¯¬åº¦ */
            padding: 12px 20px;
            border: 1px solid var(--theme-border);
            border-radius: 25px;
            background: var(--theme-input-bg);
            color: var(--theme-input-text);
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }

        .search-input::placeholder {
            color: var(--theme-input-placeholder);
        }

        .settings-btn {
            background: var(--theme-bg-trans-2);
            color: var(--theme-text);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è®Šå½¢ */
        }

        .settings-btn:hover {
            background: var(--theme-bg-trans-3);
            transform: rotate(90deg);
        }

        /* (ç§»é™¤ .controls-barï¼Œå› ç‚ºåŠŸèƒ½å·²åˆä½µåˆ° .header) */

        /* --- è¡Œäº‹æ›†ç¶²æ ¼ --- */
        .calendar-grid-container {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜å‚ç›´ç©ºé–“ */
            overflow-y: auto; /* å…§å®¹éå¤šæ™‚æ»¾å‹• */
            min-height: 0;
            border-radius: 15px;
            background: var(--theme-bg-trans-1);
            border: 1px solid var(--theme-border);
            backdrop-filter: blur(10px);
            padding: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px 5px;
            font-size: 1.1rem;
            color: var(--theme-text);
            border-bottom: 2px solid var(--theme-border);
        }

        .day-header.saturday {
            color: #2196f3;
        }

        .day-header.sunday {
            color: #f44336;
        }

        .day-cell {
            /* (å¯è‡ªè¡Œä¿®æ”¹) æ—¥æœŸæ ¼å­æœ€å°é«˜åº¦ */
            min-height: 140px;
            height: auto;
            background: var(--theme-bg-trans-1);
            border: 1px solid var(--theme-border);
            border-radius: 10px;
            padding: 8px;
            /* cursor: pointer; (v1.3.0 ç§»é™¤) æ”¹ç”± day-number è§¸ç™¼ */
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            color: var(--theme-text);
        }

        .day-cell:hover {
            background: var(--theme-bg-trans-2);
            /* transform: translateY(-2px); (ç§»é™¤) é¿å…ç©ºç™½è™•é»æ“Šçš„è¦–è¦ºå¹²æ“¾ */
        }

        .day-cell.today {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #ffc107;
        }

        .day-cell.other-month {
            opacity: 0.4;
            background: transparent;
            cursor: default;
        }
        .day-cell.other-month:hover {
            background: transparent;
        }


        .day-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            flex-shrink: 0;
            cursor: pointer; /* (æ–°å¢) æç¤ºæ—¥æœŸæ•¸å­—å¯é»æ“Š */
            display: inline-block; /* è®“é»æ“Šå€åŸŸç¬¦åˆæ–‡å­—å¤§å° */
            padding: 3px 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .day-number:hover {
            background-color: var(--theme-bg-trans-3);
        }
        .other-month .day-number {
            cursor: default;
        }
        .other-month .day-number:hover {
            background-color: transparent;
        }


        .events-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 0;
        }

        .event-item {
             /* (v1.5.0) é è¨­ä½¿ç”¨ä¸»é¡Œæ–‡å­—é¡è‰² */
             color: var(--theme-event-text, var(--color-black));
            padding: 3px 8px;
            margin: 1px 0;
            border-radius: 12px;
             /* (v1.3.0) (å¯è‡ªè¡Œä¿®æ”¹) æ—¥æœŸæ–¹æ ¼ä¸­ï¼Œäº‹ä»¶æ¨™é¡Œçš„é¡¯ç¤ºå¤§å° */
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
            /* (v1.4.0) æ–°å¢ 'ç„¡' é¡è‰²çš„é è¨­èƒŒæ™¯ */
            background: var(--theme-bg-trans-2);
        }

        /* (v1.5.0) å¼·åˆ¶æœ‰èƒŒæ™¯è‰²çš„äº‹ä»¶ä½¿ç”¨é»‘è‰²æ–‡å­— */
        .event-red, .event-blue, .event-green, .event-yellow,
        .event-purple, .event-orange, .event-pink, .event-cyan {
            color: var(--color-black) !important; /* ä½¿ç”¨ !important ç¢ºä¿è¦†è“‹ */
        }

        /* (v1.5.0) 'ç„¡' é¡è‰²çš„äº‹ä»¶ä½¿ç”¨ä¸»é¡Œæ–‡å­—é¡è‰² */
        .event-none {
             color: var(--theme-event-text, var(--color-black));
             background: var(--theme-bg-trans-2); /* ç¢ºä¿ç„¡é¡è‰²æ™‚æœ‰èƒŒæ™¯ */
        }

        /* (v1.5.0) ç§‘æŠ€é¢¨ä¸‹ 'ç„¡' é¡è‰²çš„ç‰¹æ®Šè™•ç† */
        .theme-tech .event-item.event-none {
            background: var(--theme-bg-trans-3);
            color: var(--theme-event-text); /* ç§‘æŠ€é¢¨æ–‡å­—æ˜¯ç™½è‰² */
        }
        /* (v1.5.0) ç§‘æŠ€é¢¨ä¸‹ï¼Œæ·ºè‰²èƒŒæ™¯äº‹ä»¶å¼·åˆ¶é»‘è‰²æ–‡å­— (è¦†è“‹ä¸Šé¢ .event-xxx è¦å‰‡) */
        .theme-tech .event-yellow,
        .theme-tech .event-cyan,
        .theme-tech .event-green,
        .theme-tech .event-pink,
        .theme-tech .event-red,
        .theme-tech .event-orange {
            color: var(--color-black) !important;
        }


        .event-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* äº‹ä»¶é¡è‰²æ¨™ç±¤ (v1.4.0) !important ç¢ºä¿è¦†è“‹ .event-item é è¨­èƒŒæ™¯ */
        .event-red { background: var(--event-red) !important; }
        .event-blue { background: var(--event-blue) !important; }
        .event-green { background: var(--event-green) !important; }
        .event-yellow { background: var(--event-yellow) !important; }
        .event-purple { background: var(--event-purple) !important; }
        .event-orange { background: var(--event-orange) !important; }
        .event-pink { background: var(--event-pink) !important; }
        .event-cyan { background: var(--event-cyan) !important; }

        /* --- æ¨¡æ…‹æ¡† (Modal) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
             /* (v1.6.0) ç§»é™¤ pointer-eventsï¼Œå› ç‚º overlay é»æ“Šå·²ç§»é™¤ */
             /* pointer-events: none; */
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--theme-modal-bg);
            color: var(--theme-modal-text);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--theme-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            /* (v1.5.0) é˜²æ­¢é»æ“Šå…§å®¹å€è§¸ç™¼ overlay é—œé–‰ */
            pointer-events: auto;
        }
         /* (v1.6.0) æ¢å¾© modal çš„ pointer-events (å› ç‚ºç§»é™¤äº† overlay é—œé–‰) */
         .modal {
              pointer-events: auto;
         }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--theme-modal-text);
            opacity: 0.7;
        }
        .close-btn:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* (ä¿®æ­£) æ¨¡æ…‹æ¡†å…§çš„è¼¸å…¥æ¡†æ¨£å¼ */
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="date"] { /* (v1.3.0) å¢åŠ  date input */
            width: 100%;
            padding: 10px;
            border: 1px solid var(--theme-border); /* ä¿®æ­£é‚Šæ¡† */
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            background: var(--theme-input-bg); /* ä¿®æ­£èƒŒæ™¯ */
            color: var(--theme-input-text); /* ä¿®æ­£æ–‡å­—é¡è‰² */
        }
        .form-group input[type="text"]::placeholder,
        .form-group textarea::placeholder {
             color: var(--theme-input-placeholder);
        }

        /* (v1.3.0) ä¿®æ­£æ—¥æœŸè¼¸å…¥æ¡†åœ¨ä¸åŒä¸»é¡Œä¸‹çš„é…è‰² */
        .form-group input[type="date"] {
            color-scheme: var(--theme-color-scheme, light dark);
        }


        .form-group textarea {
            /* (v1.3.0) (å¯è‡ªè¡Œä¿®æ”¹) ç®¡ç†å“¡ç·¨è¼¯äº‹ä»¶ "äº‹ä»¶å…§å®¹" çš„é è¨­é«˜åº¦ */
            height: 150px;
            resize: vertical;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option.selected {
            border-color: var(--theme-modal-text);
            transform: scale(1.2);
        }

        /* (v1.4.0) 'ç„¡' é¡è‰²é¸é …çš„æ¨£å¼ */
        .color-option.none-option {
            background: var(--theme-input-bg);
            border: 1px solid var(--theme-border);
            color: var(--theme-modal-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            box-sizing: border-box; /* ç¢ºä¿ 30x30 åŒ…å«é‚Šæ¡† */
        }
        .color-option.none-option.selected {
            border-color: var(--theme-modal-text); /* ç¢ºä¿ 'ç„¡' é¸é …é¸ä¸­æ™‚é‚Šæ¡†æ­£ç¢º */
            border-width: 3px;
        }

        .emoji-picker {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .emoji-option {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .emoji-option:hover, .emoji-option.selected {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.2);
        }

        .theme-ocean .emoji-option:hover, .theme-ocean .emoji-option.selected,
        .theme-spring .emoji-option:hover, .theme-spring .emoji-option.selected,
        .theme-meadow .emoji-option:hover, .theme-meadow .emoji-option.selected {
             background: rgba(0, 0, 0, 0.1);
        }


        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* --- ä¾¿åˆ©è²¼ (Sticky Note) --- */
        .sticky-note {
            /* (v1.4.0) ç§»é™¤ fixed å®šä½ï¼Œæ”¹ç”± JS è¨­å®š */
            background: var(--theme-sticky-bg, #ffeb3b);
            color: var(--theme-sticky-text, #333);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 999;
            cursor: move;
            width: 90%; /* (v1.4.0) å¯¬åº¦ */
            max-width: 300px; /* (v1.4.0) æœ€å¤§å¯¬åº¦ */
            font-family: 'Comic Sans MS', 'Microsoft JhengHei', cursive;
            border: 1px solid rgba(0,0,0,0.1);

            /* (v1.4.0) Flex ä½ˆå±€ + æœ€å¤§é«˜åº¦ */
            max-height: 70vh;
            display: flex;
            flex-direction: column;

             /* (v1.5.0) åˆå§‹ transform ç”± JS è¨­å®š */
             position: fixed; /* ç¢ºä¿ JS å¯ä»¥è¨­å®š top/left */
        }

        .sticky-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--theme-sticky-text);
            flex-shrink: 0; /* (v1.4.0) æ¨™é ­ä¸å£“ç¸® */
        }

        .sticky-note-controls {
            display: flex;
            gap: 5px;
        }

        .sticky-note-btn,
        .sticky-note-close {
            background: rgba(255,255,255,0.2);
            color: inherit;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            line-height: 25px;
            text-align: center;
        }

        .theme-ocean .sticky-note-btn,
        .theme-spring .sticky-note-btn,
        .theme-meadow .sticky-note-btn {
            background: rgba(0,0,0,0.1);
        }

        .sticky-note-close {
            background: var(--color-danger);
            color: white;
        }
        .sticky-note-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        .theme-ocean .sticky-note-btn:hover,
        .theme-spring .sticky-note-btn:hover,
        .theme-meadow .sticky-note-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .sticky-note-close:hover {
            opacity: 0.8;
        }

        .sticky-note-content {
            word-wrap: break-word;
            white-space: pre-wrap;
            /* (v1.4.0) å…§å®¹æ»¾å‹• */
            overflow-y: auto;
            flex-grow: 1;
            min-height: 50px; /* ç¢ºä¿æœ‰æœ€å°é«˜åº¦ */
            padding-right: 5px; /* é¿å…æ»¾å‹•æ¢å¤ªè²¼è¿‘ */
        }

        /* (v1.6.0) ä¾¿åˆ©è²¼åº•éƒ¨æ—¥æœŸ */
        .sticky-note-footer {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed var(--sticky-footer-text, rgba(0,0,0,0.3));
            font-size: 0.8rem;
            color: var(--sticky-footer-text, rgba(0,0,0,0.6));
            text-align: right;
            flex-shrink: 0;
        }


        /* --- è¨­å®šé¢æ¿ --- */
        .settings-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            /* (å¯è‡ªè¡Œä¿®æ”¹) è¨­å®šé¢æ¿å¯¬åº¦ */
            width: 320px;
            height: 100%;
            background: var(--theme-modal-bg);
            color: var(--theme-modal-text);
            backdrop-filter: blur(20px);
            z-index: 1001;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--theme-border);
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }

        /* (v1.4.0) è¨­å®šé¢æ¿çš„é—œé–‰æŒ‰éˆ• */
        .settings-panel .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        /* (æ–°å¢) ç™»å…¥å€åŸŸ */
        .login-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        #loginBtn {
            background: var(--color-primary);
            color: var(--color-white);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        #loginBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #userInfo {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--theme-bg-trans-1);
            padding: 5px 10px;
            border-radius: 25px;
        }
        #userPhoto {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--theme-border);
        }
        #userName {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--theme-text);
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #logoutBtn {
            background: var(--color-danger);
            color: var(--color-white);
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        #adminIndicator {
            color: #ffc107;
            font-weight: bold;
            font-size: 0.8rem;
            margin-left: 10px;
            display: none;
        }

        /* (v1.3.0) è¨­å®šé¢æ¿ 2x2 ç¶²æ ¼ä½ˆå±€ */
        .settings-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .settings-grid-item {
            display: flex; /* è®“æŒ‰éˆ•/é¸é …å‚ç›´å †ç–Š */
            flex-direction: column;
            gap: 5px; /* é …ç›®ä¹‹é–“çš„é–“è· */
        }

        /* (v1.3.0) ç¢ºä¿ç¶²æ ¼å…§çš„æŒ‰éˆ•å¡«æ»¿å¯¬åº¦ */
        .settings-grid-item .btn {
            width: 100%;
            margin: 0; /* ç§»é™¤èˆŠçš„ margin */
        }


        .theme-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            /* (v1.3.0) ç¢ºä¿åœ¨ç¶²æ ¼ä¸­å¤§å°ä¸€è‡´ */
            margin: 0;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .theme-ocean .theme-option:hover,
        .theme-spring .theme-option:hover,
        .theme-meadow .theme-option:hover {
            background: rgba(0, 0, 0, 0.1);
        }


        .theme-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--theme-border);
        }

        .export-section, .import-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .export-section h4, .import-section h4 {
            border-bottom: 1px solid var(--theme-border);
            padding-bottom: 5px;
            /* (v1.3.0) ç¢ºä¿æ¨™é¡Œåœ¨ç¶²æ ¼ä½ˆå±€ä¸Š */
            grid-column: 1 / -1;
            margin-bottom: 5px;
        }

        .import-section input[type="file"] {
            color: var(--theme-modal-text);
            font-size: 0.9rem;
        }

        /* æª”æ¡ˆé¸æ“‡æŒ‰éˆ•æ¨£å¼ (ç°¡æ˜“) */
        .import-section input[type="file"]::file-selector-button {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--theme-border);
            background: var(--theme-bg-trans-2);
            color: var(--theme-modal-text);
            cursor: pointer;
        }


        /* --- è‡ªè¨‚æç¤º/ç¢ºèªæ¡† --- */
        /* (v1.0.0) æé«˜æç¤ºæ¡†å±¤ç´šï¼Œç¢ºä¿åœ¨ AI è¦–çª—ä¹‹ä¸Š */
        #alertModal,
        #confirmModal {
            z-index: 1002; 
        }

        #alertModal .modal-content,
        #confirmModal .modal-content { /* (v1.5.0) ç¢ºèªæ¡†å…±ç”¨æ¨£å¼ */
            max-width: 400px;
            text-align: center;
        }
        #alertMessage,
        #confirmMessage { /* (v1.5.0) ç¢ºèªæ¡†å…±ç”¨æ¨£å¼ */
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.6;
            white-space: pre-wrap; /* (v1.4.0) è®“æç¤ºæ¡†çš„ \n æ›è¡Œç”Ÿæ•ˆ */
        }
         /* (v1.5.0) ç¢ºèªæ¡†æŒ‰éˆ•é–“è· */
        #confirmModal .btn-group {
             justify-content: center;
        }


         /* --- (v1.5.0) æœå°‹çµæœé¢æ¿ --- */
         #searchResultsPanel {
             display: none;
             position: fixed;
             left: 0;
             top: 0;
             width: var(--search-panel-width);
             height: 100%;
             background: var(--search-panel-bg, rgba(255, 255, 255, 0.9)); /* ä½¿ç”¨ä¸»é¡Œè®Šæ•¸æˆ–é è¨­ */
             backdrop-filter: blur(10px);
             border-right: 1px solid var(--theme-border);
             box-shadow: 2px 0 10px rgba(0,0,0,0.1);
             z-index: 10; /* ä½æ–¼ modal ä½†é«˜æ–¼ container */
             overflow-y: auto;
             padding: 20px;
             color: var(--theme-text);
             box-sizing: border-box;
              transition: transform 0.3s ease; /* (v1.6.0) åŠ å…¥æ»‘å…¥æ•ˆæœ */
              transform: translateX(-100%); /* (v1.6.0) é è¨­éš±è—åœ¨å·¦å´ */
         }
          /* (v1.6.0) é¢æ¿é¡¯ç¤ºæ™‚æ»‘å…¥ */
         #searchResultsPanel.visible {
              transform: translateX(0);
         }

         .search-result-item {
             padding: 10px;
             margin-bottom: 5px;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.2s ease;
             font-size: 0.9rem;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }
         .search-result-item:hover {
             background-color: var(--theme-bg-trans-2);
         }
         .search-no-result {
             padding: 10px;
             color: var(--color-grey-dark);
             font-style: italic;
         }
/* --- (v1.7.0 rev.1) åŒ¯å…¥å€å¡Šæ¨™é¡Œæ¨£å¼ --- */
        .import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .import-header h4 {
            margin: 0; /* ç§»é™¤ h4 çš„é è¨­ margin */
        }
        .btn-ai {
            /* (å¯è‡ªè¡Œä¿®æ”¹) AI è¾¨è­˜æŒ‰éˆ•çš„å¤§å° */
            padding: 5px 12px;
            font-size: 0.9rem;
        }
/* --- (v1.7.0 -> v1.8.0) AI è¾¨è­˜è¼”åŠ©å·¥å…· (æ¨£å¼æ›´æ–°) --- */
        .ai-modal-content {
            /* (v1.8.0) (å¯è‡ªè¡Œä¿®æ”¹) AI è¾¨è­˜è¦–çª—çš„æœ€å¤§å¯¬åº¦ (åŠ å¤§) */
            max-width: 1200px;
            width: 95%;
            /* (v1.8.0) (å¯è‡ªè¡Œä¿®æ”¹) AI è¾¨è­˜è¦–çª—çš„æœ€å¤§é«˜åº¦ (åŠ é«˜) */
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* (v1.8.0) æ–°å¢ API Key å€åŸŸæ¨£å¼ */
        .ai-apikey-section {
            padding: 10px 15px;
            background: var(--theme-input-bg);
            border-radius: 10px;
            border: 1px solid var(--theme-border);
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ai-apikey-section label {
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
            color: var(--theme-modal-text); /* (v1.8.0) ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º */
        }
        .ai-apikey-section input[type="password"] {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid var(--theme-border);
            background: rgba(0,0,0,0.1);
            color: var(--theme-input-text);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .theme-ocean .ai-apikey-section input[type="password"],
        .theme-spring .ai-apikey-section input[type="password"],
        .theme-meadow .ai-apikey-section input[type="password"] {
             background: rgba(255,255,255,0.4);
        }

        .ai-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            min-height: 0; /* è®“ flex-grow ç”Ÿæ•ˆçš„é—œéµ */
        }
        .ai-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--theme-input-bg);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--theme-border);
        }
        .ai-panel h4 {
            margin-top: 0;
            border-bottom: 1px solid var(--theme-border);
            padding-bottom: 10px;
        }
        .ai-panel-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0;
            margin-bottom: 10px; /* (v1.8.0) å¢åŠ ä¸‹æ–¹é–“è· */
        }
        #aiInputText {
            width: 100%;
            /* (v1.8.0) èª¿æ•´é«˜åº¦è¨ˆç®— (åŠ å¤§) */
            flex-basis: 200px; /* (å¯è‡ªè¡Œä¿®æ”¹) æ–‡å­—è¼¸å…¥å€æœ€å°é«˜åº¦ */
            flex-grow: 1;
            resize: vertical; /* (v1.8.0) å…è¨±å‚ç›´èª¿æ•´å¤§å° */
            box-sizing: border-box;
            background: rgba(0,0,0,0.1);
            color: var(--theme-input-text);
            border: 1px solid var(--theme-border);
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .theme-ocean #aiInputText, .theme-spring #aiInputText, .theme-meadow #aiInputText {
             background: rgba(255,255,255,0.4);
        }

        /* (v1.8.0) æª”æ¡ˆä¸Šå‚³å€æ¨£å¼ (åƒè€ƒ é›²æ•™å®¤é¡Œç›®ç”Ÿæˆå™¨) */
        #aiFileDropZone {
            /* (v1.8.0) (å¯è‡ªè¡Œä¿®æ”¹) æ‹–æ›³å€æœ€å°é«˜åº¦ */
            min-height: 150px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px dashed var(--theme-border);
            border-radius: 10px;
            background: rgba(0,0,0,0.05);
            color: var(--theme-modal-text);
            opacity: 0.8;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin-bottom: 10px;
        }
        .theme-ocean #aiFileDropZone, .theme-spring #aiFileDropZone, .theme-meadow #aiFileDropZone {
             background: rgba(0,0,0,0.02);
        }
        #aiFileDropZone:hover, #aiFileDropZone.drag-over {
            opacity: 1;
            border-color: var(--color-primary);
            background: rgba(33, 150, 243, 0.1);
        }
        #aiFileDropZone p {
            font-size: 0.8rem;
            margin: 5px 0 0 0;
        }
        #aiFileNameDisplay {
            font-size: 0.85rem;
            text-align: center;
            opacity: 0.9;
            margin-top: 5px;
            word-break: break-all;
            color: var(--theme-modal-text); /* (v1.8.0) ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º */
        }

        .ai-input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; /* (v1.8.0) æ¨åˆ°åº•éƒ¨ */
        }
        /* (v1.8.0) éš±è—åŸç”Ÿçš„ input[type=file] */
        .ai-input-actions input[type="file"] {
            display: none;
        }
        /* (v1.8.0) ä¿®æ­£ v1.7.0 çš„æª”æ¡ˆæŒ‰éˆ•æ¨£å¼ (å®ƒç¾åœ¨è¢«éš±è—äº†) */
        #aiImportFile {
            display: none;
        }

        .ai-result-actions {
            margin-bottom: 10px;
        }
        #aiResultsContainer {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px; /* é ç•™æ»¾å‹•æ¢ç©ºé–“ */
            /* (v1.8.0) (å¯è‡ªè¡Œä¿®æ”¹) çµæœå€æœ€å°é«˜åº¦ */
            min-height: 400px;
        }
        .ai-no-result {
            text-align: center;
            padding: 20px;
            opacity: 0.6;
        }
        .ai-result-card {
            background: var(--theme-bg-trans-1);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--theme-border);
        }
        .ai-result-header {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .ai-result-header:hover {
            background: var(--theme-bg-trans-2);
        }
        .ai-result-header h5 {
            margin: 0;
            flex-grow: 1;
        }
		/* (v1.1.0) AI çµæœå¡ç‰‡ - è¡¨å–®æ¨¡å¼ (è¦å‰‡ 1) */
        .ai-result-card.form-like {
            background: transparent; /* èƒŒæ™¯æ”¹ç‚ºé€æ˜ */
            border: none; /* ç§»é™¤é‚Šæ¡† */
            max-height: 1000px; /* (v1.1.0) ç”¨æ–¼æ¶ˆå¤±å‹•ç•« */
            transition: opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease, padding 0.5s ease, margin 0.5s ease;
        }
        .ai-result-card.form-like .ai-result-header {
             /* æ¨™é ­ç¨å¾®åŠ å€‹åº•è‰²ï¼Œèˆ‡å…§å®¹å€åˆ† */
            background: var(--theme-bg-trans-1);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--theme-border);
            border-bottom: none; /* åº•éƒ¨é‚Šæ¡†ç”± details æä¾› */
            cursor: default; /* (v1.1.0) æ¨™é ­ä¸å†æ˜¯é»æ“Šå±•é–‹ */
        }
        .ai-result-card.form-like .ai-result-header:hover {
            background: var(--theme-bg-trans-1); /* ç§»é™¤ hover æ•ˆæœ */
        }
        .ai-result-card.form-like .ai-result-details {
            /* é è¨­é¡¯ç¤º */
            display: block; 
            /* (v1.1.0) å¥—ç”¨ modal-content é¡ä¼¼çš„èƒŒæ™¯å’Œé‚Šæ¡† */
            background: rgba(0,0,0,0.05); /* çµ¦ä¸€é»é»åº•è‰² */
            border: 1px solid var(--theme-border);
            border-radius: 0 0 8px 8px;
            /* (v1.1.0) å€Ÿç”¨ modal-content çš„è¡¨å–®æ¨£å¼ */
        }
        .theme-ocean .ai-result-card.form-like .ai-result-details, 
        .theme-spring .ai-result-card.form-like .ai-result-details, 
        .theme-meadow .ai-result-card.form-like .ai-result-details {
             background: rgba(0,0,0,0.02);
        }
        .theme-tech .ai-result-card.form-like .ai-result-details {
             background: rgba(0,0,0,0.1); /* ç§‘æŠ€é¢¨åº•è‰²æ·±ä¸€é» */
        }

        /* (v1.1.0) è®“ AI å¡ç‰‡å…§çš„è¡¨å–®å…ƒç´ èˆ‡ modal å…§ä¸€è‡´ */
        .ai-result-details .form-group {
             margin-bottom: 15px;
        }
        .ai-result-details .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem; /* ç¸®å°ä¸€é»å­—é«” */
        }
        .ai-result-details .form-group input[type="text"],
        .ai-result-details .form-group textarea,
        .ai-result-details .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--theme-border);
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            background: var(--theme-input-bg);
            color: var(--theme-input-text);
        }
        .ai-result-details .form-group input[type="date"] {
            color-scheme: var(--theme-color-scheme, light dark);
        }
        .ai-result-details .form-group .color-picker,
        .ai-result-details .form-group .emoji-picker {
            /* å€Ÿç”¨ modal å…§çš„æ¨£å¼ */
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        /* (v1.1.0) ç¢ºä¿ AI ä»‹é¢ä¸­çš„é¸é …å¯é»æ“Š */
        .ai-result-details .color-option,
        .ai-result-details .emoji-option {
             cursor: pointer;
        }
        /* (v1.1.0) AI ä»‹é¢ä¸­çš„é¸é …é¸ä¸­æ¨£å¼ */
        .ai-result-details .color-option.selected {
            border-color: var(--theme-modal-text);
            transform: scale(1.2);
        }
        .ai-result-details .color-option.none-option.selected {
            border-color: var(--theme-modal-text);
            border-width: 3px;
        }
        .ai-result-details .emoji-option.selected {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.2);
        }
        .theme-ocean .ai-result-details .emoji-option.selected,
        .theme-spring .ai-result-details .emoji-option.selected,
        .theme-meadow .ai-result-details .emoji-option.selected {
             background: rgba(0, 0, 0, 0.1);
        }

        /* (v1.1.0) éŒ¯èª¤éœ‡å‹•å‹•ç•« */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .ai-result-details {
            display: none; /* é è¨­éš±è— */
            padding: 15px;
            border-top: 1px solid var(--theme-border);
            white-space: pre-wrap; /* è®“æ›è¡Œç”Ÿæ•ˆ */
            line-height: 1.7;
            font-size: 0.9rem;
            background: rgba(0,0,0,0.05);
        }
        .theme-ocean .ai-result-details, .theme-spring .ai-result-details, .theme-meadow .ai-result-details {
             background: rgba(0,0,0,0.02);
        }
		/* (v1.0.0) AI çµæœç·¨è¼¯å€æ¨£å¼ */
        .ai-result-textarea {
            width: 100%;
            height: 150px; /* (å¯è‡ªè¡Œä¿®æ”¹) AI çµæœç·¨è¼¯å€é è¨­é«˜åº¦ */
            box-sizing: border-box;
            background: rgba(0,0,0,0.1);
            color: var(--theme-input-text);
            border: 1px solid var(--theme-border);
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9rem;
            resize: vertical;
        }
        .theme-ocean .ai-result-textarea, 
        .theme-spring .ai-result-textarea, 
        .theme-meadow .ai-result-textarea {
             background: rgba(255,255,255,0.4);
             color: var(--color-black);
        }
        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
        @media (max-width: 900px) {
            /* (å¯è‡ªè¡Œä¿®æ”¹) ç•¶å¯¬åº¦å°æ–¼ 900px æ™‚ï¼Œå–æ¶ˆç¸®æ”¾ */
            body {
                padding-left: 0 !important; /* æ‰‹æ©Ÿç‰ˆä¸ç‚ºæœå°‹é¢æ¿ç•™ç©ºé–“ */
            }
             /* (v1.6.0) æ‰‹æ©Ÿç‰ˆå®¹å™¨ä¸å³ç§» */
             body.search-panel-visible .container {
                 transform: scale(1.0) translateX(0);
             }
            .container {
                height: 100vh; /* æ¢å¾©æ­£å¸¸é«˜åº¦ */
                transform: scale(1.0); /* å–æ¶ˆç¸®æ”¾ */
                padding: 10px;
                 transition: none; /* (v1.6.0) æ‰‹æ©Ÿç‰ˆå–æ¶ˆå®¹å™¨ä½ç§»éæ¸¡ */
            }

             /* (v1.5.0) æ‰‹æ©Ÿç‰ˆæœå°‹é¢æ¿èª¿æ•´ */
             #searchResultsPanel {
                  width: 100%;
                  max-width: 300px; /* æˆ–å…¶ä»–åˆé©å¯¬åº¦ */
                  border-right: none;
                  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                  z-index: 1003; /* æ¯” modal é«˜ */
             }


            .header {
                grid-template-columns: 1fr 1fr; /* ç°¡åŒ–ç‚ºå…©æ¬„ */
                gap: 15px;
            }
            .header-left {
                grid-column: 1 / 2;
                justify-self: start;
            }
            .header-center {
                grid-column: 1 / 3; /* æœˆä»½å°èˆªä½”æ»¿ç¬¬äºŒè¡Œ */
                grid-row: 2 / 3;
                justify-self: center;
            }
            .header-right {
                grid-column: 2 / 3;
                grid-row: 1 / 2;
                justify-self: end;
            }

            .calendar-title {
                font-size: 1.5rem;
            }
            .nav-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            .month-select, .year-select {
                font-size: 1rem;
                padding: 8px 10px;
                min-width: 80px;
            }
            .search-input {
                min-width: auto;
                width: 150px; /* (å¯è‡ªè¡Œä¿®æ”¹) æ‰‹æ©Ÿç‰ˆæœå°‹æ¡†å¯¬åº¦ */
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .calendar-grid-container {
                flex-grow: 1;
                min-height: 450px; /* ç¢ºä¿æœ‰æœ€å°é«˜åº¦ */
            }
            .day-cell {
                min-height: 100px; /* æ‰‹æ©Ÿä¸Šæ ¼å­å°ä¸€é» */
                padding: 5px;
            }
            .day-number {
                font-size: 1rem;
            }
            .event-item {
                /* (v1.3.0) æ‰‹æ©Ÿæ¿å­—é«”å¤§å°èª¿æ•´ */
                font-size: 0.8rem;
                padding: 2px 5px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .settings-panel {
                width: 100%;
                max-width: 300px; /* æ‰‹æ©Ÿä¸Šæœ€å¤§å¯¬åº¦ */
            }
        }

        @media (max-width: 480px) {
            .header-center {
                gap: 5px; /* é€²ä¸€æ­¥ç¸®å°æ‰‹æ©Ÿä¸Šçš„é–“è· */
            }
            .month-select, .year-select {
                min-width: 70px;
            }
            .search-input {
                width: 120px; /* (å¯è‡ªè¡Œä¿®æ”¹) æœ€å°æ‰‹æ©Ÿç‰ˆæœå°‹æ¡†å¯¬åº¦ */
            }

            /* (v1.3.0) æ‰‹æ©Ÿæ¿è¨­å®šç¶²æ ¼æ”¹å›å–®æ¬„ */
            .settings-grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // è¨­å®š pdf.js çš„ worker è·¯å¾‘
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
</head>
</head>

<!-- (v1.6.0) body class æœƒç”± JS å‹•æ…‹å¢æ¸› search-panel-visible -->
<body>
    <!-- (v1.5.0) æœå°‹çµæœé¢æ¿ -->
    <div id="searchResultsPanel">
        <!-- æœå°‹çµæœå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </div>


    <div class="container">

        <!-- æ¨™é¡Œå€åŸŸ (ç‰ˆé¢é‡æ§‹) -->
        <div class="header">
            <!-- å·¦å´ -->
            <div class="header-left">
                <!-- (å¯è‡ªè¡Œä¿®æ”¹) æ¨™é¡Œæ–‡å­— -->
                <h1 class="calendar-title" id="calendarTitle">ğŸ“… é›²æ•™å®¤è¡Œäº‹æ›†</h1>
                <button class="nav-btn" onclick="goToToday()">ğŸ“ ä»Šå¤©</button>
            </div>

            <!-- ä¸­é–“ -->
            <div class="header-center">
                <button class="nav-btn" onclick="previousMonth()">â¬…ï¸ ä¸Šå€‹æœˆ</button>
                <div class="month-year">
                    <select class="month-select" id="monthSelect" onchange="changeMonth()">
                        <option value="0">1æœˆ</option> <option value="1">2æœˆ</option> <option value="2">3æœˆ</option>
                        <option value="3">4æœˆ</option> <option value="4">5æœˆ</option> <option value="5">6æœˆ</option>
                        <option value="6">7æœˆ</option> <option value="7">8æœˆ</option> <option value="8">9æœˆ</option>
                        <option value="9">10æœˆ</option> <option value="10">11æœˆ</option> <option value="11">12æœˆ</option>
                    </select>
                    <select class="year-select" id="yearSelect" onchange="changeYear()"></select>
                </div>
                <button class="nav-btn" onclick="nextMonth()">ä¸‹å€‹æœˆ â¡ï¸</button>
            </div>

            <!-- å³å´ -->
            <div class="header-right">
                <div class="search-container">
                    <!-- (å¯è‡ªè¡Œä¿®æ”¹) æœå°‹æç¤ºæ–‡å­— -->
                    <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹äº‹ä»¶..." >
                    <!-- (v1.5.0) ç§»é™¤ oninputï¼Œæ”¹ç”¨ addEventListener -->
                </div>
                <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
            </div>
        </div>

        <!-- (ç§»é™¤ .controls-bar) -->

        <!-- è¡Œäº‹æ›†ç¶²æ ¼ (å®¹å™¨) -->
        <div class="calendar-grid-container">
            <div class="calendar-grid" id="calendarGrid">
                <!-- æ˜ŸæœŸæ¨™é¡Œ -->
                <div class="day-header">ä¸€</div>
                <div class="day-header">äºŒ</div>
                <div class="day-header">ä¸‰</div>
                <div class="day-header">å››</div>
                <div class="day-header">äº”</div>
                <div class="day-header saturday">å…­</div>
                <div class="day-header sunday">æ—¥</div>
                <!-- æ—¥æœŸæ ¼å­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯äº‹ä»¶æ¨¡æ…‹æ¡† -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ğŸ“ æ–°å¢äº‹ä»¶</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <form id="eventForm">
                <div class="form-group">
                    <label for="eventTitle">ğŸ“‹ äº‹ä»¶æ¨™é¡Œï¼š</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label for="eventContent">ğŸ“„ äº‹ä»¶å…§å®¹ï¼š</label>
                    <!-- (v1.3.0) "äº‹ä»¶å…§å®¹" é«˜åº¦å·²åœ¨ <style> ä¸­è¢« CSS ( .form-group textarea ) é–å®šï¼Œå¯è‡³è©²è™•ä¿®æ”¹ -->
                    <textarea id="eventContent"></textarea>
                </div>
                 <!-- (v1.5.0) æ–°å¢æ—¥æœŸç¯„åœ -->
                 <div class="form-group">
                    <label for="eventStartDate">ğŸ—“ï¸ é–‹å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="eventStartDate" required>
                </div>
                <div class="form-group">
                    <label for="eventEndDate">ğŸ—“ï¸ çµæŸæ—¥æœŸï¼š</label>
                    <input type="date" id="eventEndDate" required>
                </div>
                <div class="form-group">
                    <label>ğŸ¨ é¡è‰²æ¨™ç±¤ï¼š</label>
                    <div class="color-picker">
                        <!-- (v1.4.0) æ–°å¢ 'ç„¡' é¸é … -->
                        <div class="color-option none-option" data-color="">ç„¡</div>
                        <!-- (å¯è‡ªè¡Œä¿®æ”¹) é¡è‰²é¸é … -->
                        <div class="color-option" style="background: var(--event-red)" data-color="red"></div>
                        <div class="color-option" style="background: var(--event-blue)" data-color="blue"></div>
                        <div class="color-option" style="background: var(--event-green)" data-color="green"></div>
                        <div class="color-option" style="background: var(--event-yellow)" data-color="yellow"></div>
                        <div class="color-option" style="background: var(--event-purple)" data-color="purple"></div>
                        <div class="color-option" style="background: var(--event-orange)" data-color="orange"></div>
                        <div class="color-option" style="background: var(--event-pink)" data-color="pink"></div>
                        <div class="color-option" style="background: var(--event-cyan)" data-color="cyan"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸ˜Š è¡¨æƒ…ç¬¦è™Ÿï¼š</label>
                    <div class="emoji-picker">
                        <!-- (å¯è‡ªè¡Œä¿®æ”¹) Emoji é¸é … -->
                        <span class="emoji-option" data-emoji="">ç„¡</span> <span class="emoji-option" data-emoji="ğŸ“–">ğŸ“–</span>
                        <span class="emoji-option" data-emoji="ğŸ¥°">ğŸ¥°</span> <span class="emoji-option" data-emoji="ğŸ‰">ğŸ‰</span>
                        <span class="emoji-option" data-emoji="ğŸ“">ğŸ“</span> <span class="emoji-option" data-emoji="ğŸ’–">ğŸ’–</span>
                        <span class="emoji-option" data-emoji="ğŸ°">ğŸ°</span> <span class="emoji-option" data-emoji="ğŸ">ğŸ</span>
                        <span class="emoji-option" data-emoji="ğŸ”¥">ğŸ”¥</span> <span class="emoji-option" data-emoji="ğŸµ">ğŸµ</span>
                        <span class="emoji-option" data-emoji="ğŸŒˆ">ğŸŒˆ</span> <span class="emoji-option" data-emoji="ğŸŒŸ">ğŸŒŸ</span>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteEvent()" style="display: none;">åˆªé™¤</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn" style="display: none;">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (v1.3.0) è‡ªè¨‚åŒ¯å‡ºæ—¥æœŸç¯„åœæ¨¡æ…‹æ¡† -->
    <div class="modal" id="customExportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ—“ï¸ è‡ªè¨‚åŒ¯å‡ºç¯„åœ</h3>
                <button class="close-btn" onclick="closeCustomExportModal()">Ã—</button>
            </div>
            <form id="customExportForm" onsubmit="event.preventDefault(); exportCustomRange();">
                <div class="form-group">
                    <label for="exportStartDate">é–‹å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="exportStartDate" required>
                </div>
                <div class="form-group">
                    <label for="exportEndDate">çµæŸæ—¥æœŸï¼š</label>
                    <input type="date" id="exportEndDate" required>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomExportModal()">å–æ¶ˆ</button>
                    <!-- (v1.3.0) ä¿®æ”¹ type ç‚º submit æˆ– button å‡å¯ï¼Œå·²ç”± form onsubmit è™•ç† -->
                    <button type="button" class="btn btn-primary" onclick="exportCustomRange()">ç¢ºèªåŒ¯å‡º</button>
                </div>
            </form>
        </div>
    </div>


    <!-- è¨­å®šé¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <!-- (v1.4.0) æ–°å¢é—œé–‰æŒ‰éˆ• -->
        <button class="close-btn" onclick="toggleSettings()">Ã—</button>

        <!-- (v1.3.0) ç§»é™¤ 'âš™ï¸ è¨­å®š' æ¨™é¡Œï¼Œä½¿æ•´é«”ä¸Šç§» -->

        <!-- (æ–°å¢) ç™»å…¥å€åŸŸ -->
        <div class="login-section">
            <h4>ğŸ”‘ å¸³è™Ÿç‹€æ…‹</h4>
            <button id="loginBtn" onclick="loginWithGoogle()">ğŸš€ ä½¿ç”¨ Google ç™»å…¥</button>
            <div id="userInfo" style="display: none;">
                <img id="userPhoto" src="" alt="User">
                <span id="userName"></span>
                <span id="adminIndicator">ğŸ‘‘</span>
                <button id="logoutBtn" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <h4>ğŸ¨ ä¸»é¡Œé¢¨æ ¼</h4>
        <!-- (v1.3.0) æ”¹ç‚º 2x2 ç¶²æ ¼ -->
        <div class="settings-grid-container">
            <div class="theme-option" onclick="changeTheme('tech')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #1a1a2e, #16213e);"></div><span>ğŸ–¥ï¸ ç§‘æŠ€é¢¨</span>
            </div>
            <div class="theme-option" onclick="changeTheme('ocean')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);"></div><span>ğŸŒŠ æµ·æ´‹é¢¨</span>
            </div>
            <div class="theme-option" onclick="changeTheme('spring')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #fce4ec, #f8bbd9);"></div><span>ğŸŒ¸ æ˜¥å¤©é¢¨</span>
            </div>
            <div class="theme-option" onclick="changeTheme('meadow')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9);"></div><span>ğŸŒ¿ è‰åŸé¢¨</span>
            </div>
        </div>

        <div class="export-section">
            <h4>ğŸ“¤ åŒ¯å‡ºè³‡æ–™ (åƒ…é™ç®¡ç†å“¡)</h4>
            <!-- (v1.3.0) æ”¹ç‚º 2x2 ç¶²æ ¼ï¼Œä¸¦ä¿®æ”¹æ–‡å­—èˆ‡ 'è‡ªè¨‚' çš„ onclick -->
            <div class="settings-grid-container">
                <div class="settings-grid-item">
                    <button class="btn btn-primary" onclick="exportData('all')">å…¨éƒ¨</button>
                </div>
                <div class="settings-grid-item">
                    <button class="btn btn-primary" onclick="exportData('year')">è©²å¹´</button>
                </div>
                <div class="settings-grid-item">
                    <button class="btn btn-primary" onclick="exportData('month')">è©²æœˆ</button>
                </div>
                <div class="settings-grid-item">
                    <button class="btn btn-primary" onclick="openCustomExportModal()">è‡ªè¨‚</button>
                </div>
            </div>
        </div>

        <div class="import-section">
            <div class="import-header">
                <h4>ğŸ“¥ åŒ¯å…¥</h4>
                <button class="btn btn-primary btn-ai" onclick="openAiHelperModal()">ğŸ¤– AI è¾¨è­˜</button>
            </div>
            <p class="ai-panel-desc" style="text-align: center; margin-top: 5px; margin-bottom: 15px;">(å¯ä½¿ç”¨ AI è¼”åŠ©ï¼Œæˆ–å¾ä¸‹æ–¹åŒ¯å…¥ .json æª”æ¡ˆ)</p>
            <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px; width: 100%;">
            <button class="btn btn-secondary" onclick="importData()" style="width: 100%;">åŒ¯å…¥ .json æª”æ¡ˆ</button>
        </div>
            </div>
        </div>
        </div>

        <!-- (v1.4.0) ç§»é™¤ "é—œé–‰è¨­å®š" æŒ‰éˆ• -->
    </div>

    <!-- è‡ªè¨‚æç¤ºæ¡† (Alert Modal) -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”” ç³»çµ±æç¤º</h3>
                <button class="close-btn close-alert">Ã—</button>
            </div>
            <p id="alertMessage">é€™æ˜¯ä¸€æ¢æç¤ºè¨Šæ¯ã€‚</p>
            <div class="btn-group">
                <button type="button" class="btn btn-primary close-alert">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

     <!-- (v1.5.0) è‡ªè¨‚ç¢ºèªæ¡† (Confirm Modal) -->
     <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">ğŸ’¡ è«‹ç¢ºèª</h3>
                <button class="close-btn close-confirm">Ã—</button>
            </div>
            <p id="confirmMessage">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="btn-group">
                 <button type="button" class="btn btn-secondary close-confirm" id="confirmCancelBtn">å–æ¶ˆ</button>
                 <button type="button" class="btn btn-primary" id="confirmOkBtn">ç¢ºå®š</button>
                 <!-- (v1.5.0) å¯ä»¥åœ¨é€™è£¡æ·»åŠ ç¬¬ä¸‰å€‹æŒ‰éˆ• if needed -->
            </div>
        </div>
    </div>
<div class="modal" id="aiHelperModal">
    <div class="modal-content ai-modal-content">
        <div class="modal-header">
            <h3>ğŸ¤– AI è¡Œäº‹æ›†è¾¨è­˜å·¥å…·</h3>
            <button class="close-btn" onclick="closeAiHelperModal()">Ã—</button>
        </div>

        <div class="ai-apikey-section">
            <label for="aiApiKeyInput">ğŸ”‘ Google AI Keyï¼š</label>
            <input type="password" id="aiApiKeyInput" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google AI API é‡‘é‘° (é‡‘é‘°å°‡å„²å­˜æ–¼ç€è¦½å™¨)">
            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="saveAiApiKey()">å„²å­˜</button>
        </div>

        <div class="ai-container">
            <div class="ai-panel ai-input-panel">
                <h4>[1] æä¾›å…§å®¹</h4>
                <p class="ai-panel-desc">è«‹è²¼ä¸Šæ–‡å­—ã€æˆ–ä¸Šå‚³ .txt, .pdf, åœ–ç‰‡æª”ã€‚AI å°‡è‡ªå‹•ç‚ºæ‚¨è§£ææ´»å‹•è³‡è¨Šã€‚</p>
                
                <label for="aiImportFile" id="aiFileDropZone">
                    <span style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ“¤</span>
                    <strong>é»æ“Šæ­¤è™•ä¸Šå‚³æª”æ¡ˆ</strong>
                    <p>æˆ–å°‡ .txt / .pdf / åœ–ç‰‡æª”æ‹–æ›³è‡³æ­¤</p>
                </label>
                <div id="aiFileNameDisplay">å°šæœªé¸æ“‡æª”æ¡ˆ</div>
                <input type="file" id="aiImportFile" accept=".txt,.pdf,image/*" multiple style="display: none;">

                <label for="aiInputText" style="font-size: 0.9rem; margin-top: 15px; margin-bottom: 5px; display: block;">æˆ–åœ¨æ­¤è²¼ä¸Šç´”æ–‡å­—ï¼š</label>
                <textarea id="aiInputText" placeholder="ä¾‹å¦‚ï¼š
7/10 æ™šä¸Š8é»æ˜¯ Canva ç¶²é è¨­è¨ˆæ•™å­¸
åœ°é»åœ¨ Youtube ç›´æ’­
è¬›å¸«æ˜¯é»ƒä¿¡æº¢..."></textarea>
                
                <div class="ai-input-actions">
                    <button class="btn btn-secondary" onclick="clearAiInput()">æ¸…é™¤è¼¸å…¥</button>
                    <button class="btn btn-primary" onclick="processAiInput()">ğŸ§  é–‹å§‹è¾¨è­˜</button>
                </div>
            </div>

            <div class="ai-panel ai-results-panel">
                <h4>[2] è¾¨è­˜çµæœ</h4>
                <p class="ai-panel-desc">é»æ“Šæ¨™é¡Œå¯å±•é–‹è©³ç´°è³‡è¨Šã€‚ç¢ºèªç„¡èª¤å¾Œå³å¯åŒ¯å…¥è¡Œäº‹æ›†ã€‚</p>
                <div class="ai-result-actions">
                    <button id="importAllAiBtn" class="btn btn-primary" onclick="importAllAiEvents()" style="display: none;">å…¨éƒ¨åŒ¯å…¥</button>
                </div>
                <div id="aiResultsContainer">
                    <div class="ai-no-result">å°šç„¡è¾¨è­˜çµæœ</div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
